<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Puissance 4</title>
    <link rel="stylesheet" href="/static/font.css">
    <style>
        /* Particles.js background - cach√© en mode classique */
        #particles-js {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        /* Mode classique : fond r√©tro */
        body.mode-classique #particles-js {
            display: none;
        }
        body.mode-classique {
            background: url('/images/retro-background.gif') no-repeat center center fixed;
            background-size: cover;
        }
        
        /* Background image */
        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            font-family: system-ui, sans-serif;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            gap: 2rem;
            position: relative;
        }
        /* Game container centered */
        .game-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            max-width: 650px;
            position: relative;
            z-index: 1;
        }
        /* Scoreboard */
        .scoreboard {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            min-width: 200px;
            position: relative;
            z-index: 1;
        }
        .scoreboard h2 {
            margin: 0 0 1rem 0;
            font-size: 1.25rem;
            text-align: center;
            color: #0f172a;
        }
        .score-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            margin: 0.5rem 0;
            background: #f1f5f9;
            border-radius: 8px;
            border-left: 4px solid;
        }
        .score-item.player-r {
            border-left-color: #ef4444;
        }
        .score-item.player-y {
            border-left-color: #f59e0b;
        }
        .score-item .player-name {
            font-weight: 600;
            color: #0f172a;
        }
        .score-item .player-score {
            font-size: 1.5rem;
            font-weight: bold;
            color: #0f172a;
        }
        @media (max-width: 1024px) {
            body {
                flex-direction: column;
                gap: 1rem;
            }
        }
        h1 {
            margin: 0 0 1rem 0;
            text-align: center;
            color: #0f172a;
        }
        /* board layout */
        .board { border-collapse: collapse; margin: 1rem auto; table-layout: fixed; }
    /* increased cell size for better visibility */
    .board td { width: 60px; height: 60px; border: 3px solid #0f172a; background: #60a5fa; padding: 0; position: relative; text-align: center; vertical-align: middle; }
        .board th { padding: 0; }
    /* token circle - larger */
    .cell { width: 48px; height: 48px; border-radius: 50%; margin: 5px auto; background: #ffffff; display: block; box-shadow: inset 0 2px 4px rgba(2,6,23,0.06); border: 1px solid rgba(2,6,23,0.06); }
        .cell.R { background: #ef4444; box-shadow: none; border-color: rgba(0,0,0,0.06); }
        .cell.Y { background: #f59e0b; box-shadow: none; border-color: rgba(0,0,0,0.06); }
    /* column buttons - bigger */
    .col-button { background: rgba(255,255,255,0.92); border: 1px solid rgba(15,23,42,0.12); cursor: pointer; width: 60px; height: 48px; display: flex; align-items: center; justify-content: center; font-size: 24px; line-height: 1; color: #0f172a; border-radius: 6px; }
    .col-button:hover { background: white; box-shadow: 0 1px 3px rgba(2,6,23,0.08); }
    .col-button:disabled { opacity: 0.35; cursor: not-allowed; background: rgba(255,255,255,0.7); }
    .col-button.blocked-column { 
        background: #ef4444 !important; 
        color: white !important; 
        border-color: #dc2626 !important;
        opacity: 1 !important;
        cursor: not-allowed !important;
        box-shadow: 0 0 15px rgba(239, 68, 68, 0.6) !important;
        animation: blockPulse 2s ease-in-out infinite;
    }
    @keyframes blockPulse {
        0%, 100% { box-shadow: 0 0 15px rgba(239, 68, 68, 0.6); }
        50% { box-shadow: 0 0 25px rgba(239, 68, 68, 0.9); }
    }
        .info { display:flex; gap:1rem; align-items:center }
    /* reset button distinctive */
    #reset { background: #1d4ed8; color: white; border: none; padding: 0.5rem 0.75rem; border-radius: 6px; cursor: pointer; }
    #reset:hover { background: #1e40af; }
    #reset:active { transform: translateY(1px); }
    #reset:focus { outline: 3px solid rgba(29,78,216,0.18); }
        @media (max-width: 480px) {
            .board td { width: 50px; height: 50px; }
            .cell { width: 40px; height: 40px; }
            .col-button { width: 50px; height: 42px; font-size: 20px; }
        }
        /* animation for dropping token - adjusted for larger size */
        .floating-token {
            position: absolute;
            width: 48px; height: 48px; border-radius: 50%;
            pointer-events: none; z-index: 20; transform: translateY(0);
            transition: transform 450ms cubic-bezier(.22,.9,.33,1);
        }
        .floating-token.R { background: #ef4444; }
        .floating-token.Y { background: #f59e0b; }
        
        /* Ghost animation effect */
        .ghost-anim {
            position: fixed;
            pointer-events: none;
            z-index: 999999;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            animation: ghostBounce 3s ease-in-out;
            opacity: 0;
            filter: drop-shadow(0 0 50px rgba(255, 255, 255, 1));
        }
        
        @keyframes ghostBounce {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.1);
            }
            15% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.5);
            }
            30% {
                transform: translate(-50%, -50%) scale(1.3);
            }
            50% {
                transform: translate(-50%, -50%) scale(1.4);
            }
            70% {
                transform: translate(-50%, -50%) scale(1.35);
            }
            85% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.3);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }
        }
        
        /* Boosters Panel */
        .boosters-panel {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(17, 24, 39, 0.95);
            border: 2px solid #3b82f6;
            border-radius: 16px;
            padding: 20px;
            min-width: 250px;
            max-width: 300px;
            box-shadow: 0 10px 40px rgba(59, 130, 246, 0.3);
            z-index: 100;
            backdrop-filter: blur(10px);
        }
        
        /* Positionner le panneau du joueur 1 √† gauche */
        .boosters-panel.boosters-player1 {
            left: 20px;
            border-color: #ef4444;
            box-shadow: 0 10px 40px rgba(239, 68, 68, 0.3);
        }
        
        .boosters-panel.boosters-player1 h2 {
            color: #f87171;
            border-bottom-color: #ef4444;
        }
        
        /* Positionner le panneau du joueur 2 √† droite */
        .boosters-panel.boosters-player2 {
            right: 20px;
            left: auto;
            border-color: #f59e0b;
            box-shadow: 0 10px 40px rgba(245, 158, 11, 0.3);
        }
        
        .boosters-panel.boosters-player2 h2 {
            color: #fbbf24;
            border-bottom-color: #f59e0b;
        }
        
        .boosters-panel h2 {
            margin: 0 0 15px 0;
            font-size: 1.3rem;
            text-align: center;
            padding-bottom: 10px;
        }
        
        .boosters-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .booster-card {
            background: linear-gradient(135deg, #1e40af 0%, #3730a3 100%);
            border: 2px solid #60a5fa;
            border-radius: 12px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            animation: boosterAppear 0.5s ease-out;
        }
        
        .booster-card:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 20px rgba(96, 165, 250, 0.5);
            border-color: #93c5fd;
        }
        
        .booster-card.used,
        .booster-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: linear-gradient(135deg, #374151 0%, #1f2937 100%);
            border-color: #4b5563;
        }
        
        .booster-card.disabled:hover {
            transform: none;
            box-shadow: none;
        }
        
        /* Griser les panneaux quand ce n'est pas le tour du joueur */
        .boosters-panel.inactive {
            opacity: 0.4;
            pointer-events: none;
        }
        
        .booster-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        
        .booster-icon {
            font-size: 1.8rem;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }
        
        .booster-name {
            font-size: 1.1rem;
            font-weight: bold;
            color: #fff;
        }
        
        .booster-description {
            font-size: 0.85rem;
            color: #cbd5e1;
            line-height: 1.4;
        }
        
        .no-boosters {
            text-align: center;
            color: #94a3b8;
            padding: 20px 10px;
        }
        
        .no-boosters p {
            margin: 0 0 8px 0;
            font-size: 1rem;
        }
        
        .no-boosters small {
            font-size: 0.8rem;
            color: #64748b;
        }
        
        @keyframes boosterAppear {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        /* Hide boosters panel in non-turbo modes */
        body:not(.mode-turbo) .boosters-panel {
            display: none !important;
        }
    </style>
</head>
<body class="mode-{{.Mode}}">
    <div class="game-container">
        <h1>Puissance 4</h1>
        <div class="info">
        <div id="status">
            {{if .Finished}}
                {{if .Winner}}
                    {{if eq .Winner "R"}}
                        üéâ Gagnant: {{.Player1Name}} üî¥! | Prochain d√©fi: {{add .WinLength 1}} pions align√©s!
                    {{else}}
                        üéâ Gagnant: {{.Player2Name}} üü°! | Prochain d√©fi: {{add .WinLength 1}} pions align√©s!
                    {{end}}
                {{else}}
                    Match nul
                {{end}}
            {{else}}
                {{if eq .Next "R"}}
                    Au tour de: {{.Player1Name}} üî¥ | Objectif: {{.WinLength}} pions align√©s
                {{else}}
                    Au tour de: {{.Player2Name}} üü° | Objectif: {{.WinLength}} pions align√©s
                {{end}}
            {{end}}
        </div>
        <div style="display:inline-flex;align-items:center;gap:.5rem">
            <div id="compteDisplay" style="background:#16a34a;color:white;padding:0.5rem 0.75rem;border-radius:6px;font-weight:bold;">
                Clics: <span id="compteValue">0</span>
            </div>
            <form method="post" action="/next-level" style="display:inline">
                <button id="nextLevel" type="submit">Nouvelle partie</button>
            </form>
            <form method="post" action="/reset" style="display:inline">
                <button id="reset" type="submit" style="background:#dc2626;border:none;padding:0.5rem 0.75rem;border-radius:6px;cursor:pointer;color:white;" title="R√©initialiser la grille et la difficult√©">üîÑ Reset Complet</button>
            </form>
            <button id="effectsToggle" type="button" aria-pressed="true" title="Activer/d√©sactiver les effets">Effets</button>
        </div>
    </div>

    <form method="post" action="/play" id="playForm">
        <input type="hidden" name="column" id="hiddenColumn" value="">
        <table class="board" aria-label="Plateau de jeu">
            <thead>
                <tr>
                    {{range $col := seq 0 (sub .Cols 1)}}
                    <th>
                        <button class="col-button {{if eq $col $.BlockedColumn}}blocked-column{{end}}" data-column="{{$col}}" type="submit" {{if $.Finished}}disabled{{end}} {{if eq $col $.BlockedColumn}}disabled{{end}}>{{if eq $col $.BlockedColumn}}üö´{{else}}‚ñº{{end}}</button>
                    </th>
                    {{end}}
                </tr>
            </thead>
            <tbody>
                {{range $r := seq 0 (sub $.Rows 1)}}
                <tr>
                    {{range $c := seq 0 (sub $.Cols 1)}}
                    <td>
                        {{ $cell := index $.Board $r $c }}
                        <span class="cell {{if $cell}}{{$cell}}{{end}}"></span>
                    </td>
                    {{end}}
                </tr>
                {{end}}
            </tbody>
        </table>
    </form>
    </div>
    
    <!-- Scoreboard -->
    <div class="scoreboard">
        <h2>üèÜ Scores</h2>
        <div class="score-item player-r">
            <span class="player-name">üî¥ {{.Player1Name}}</span>
            <span class="player-score" id="scoreR">0</span>
        </div>
        <div class="score-item player-y">
            <span class="player-name">üü° {{.Player2Name}}</span>
            <span class="player-score" id="scoreY">0</span>
        </div>
    </div>
    
    <!-- Boosters Panel Player 1 (visible only in turbo mode) -->
    <div class="boosters-panel boosters-player1" id="boostersPanelR" style="display: none;">
        <h2>‚ö° {{.Player1Name}} üî¥</h2>
        <div class="boosters-list" id="boostersListR">
            <!-- Les boosters du joueur 1 seront ajout√©s dynamiquement ici -->
            <div class="no-boosters" id="noBoostersR">
                <p>Aucun booster</p>
                <small>En attente...</small>
            </div>
        </div>
    </div>
    
    <!-- Boosters Panel Player 2 (visible only in turbo mode) -->
    <div class="boosters-panel boosters-player2" id="boostersPanelY" style="display: none;">
        <h2>‚ö° {{.Player2Name}} üü°</h2>
        <div class="boosters-list" id="boostersListY">
            <!-- Les boosters du joueur 2 seront ajout√©s dynamiquement ici -->
            <div class="no-boosters" id="noBoostersY">
                <p>Aucun booster</p>
                <small>En attente...</small>
            </div>
        </div>
    </div>
    
    <!-- Particles.js container for animated background -->
    <div id="particles-js"></div>
    
    <!-- Fullscreen decorative canvas for textures/animations -->
    <canvas id="bgCanvas" aria-hidden="true" style="position:fixed;inset:0;z-index:-1;pointer-events:none;" ></canvas>
    <script>
        // D√©tecter le mode de jeu
        var gameMode = document.body.className.replace('mode-', '');
        console.log('[Mode] Mode de jeu actuel:', gameMode);
        
        // Gestion des boosters (mode Turbo uniquement)
        var boostersR = []; // Boosters du joueur 1 (Rouge)
        var boostersY = []; // Boosters du joueur 2 (Jaune)
        var boostersPanelR = document.getElementById('boostersPanelR');
        var boostersPanelY = document.getElementById('boostersPanelY');
        var boostersListR = document.getElementById('boostersListR');
        var boostersListY = document.getElementById('boostersListY');
        var noBoostersR = document.getElementById('noBoostersR');
        var noBoostersY = document.getElementById('noBoostersY');
        
        // Afficher les panneaux des boosters en mode turbo
        if(gameMode === 'turbo') {
            if(boostersPanelR) boostersPanelR.style.display = 'block';
            if(boostersPanelY) boostersPanelY.style.display = 'block';
            console.log('[Boosters] Panneaux activ√©s en mode Turbo');
        }
        
        // D√©finition des types de boosters disponibles
        var boosterTypes = {
            'double-shot': {
                name: '‚ö° Double Coup',
                description: 'Jouez deux fois d\'affil√©e',
                icon: '‚ö°'
            },
            'remove-piece': {
                name: 'üóëÔ∏è Effaceur',
                description: 'Retirez un pion adverse du plateau',
                icon: 'üóëÔ∏è'
            },
            'block-column': {
                name: 'üö´ Bloqueur',
                description: 'Bloquez une colonne pendant un tour',
                icon: 'üö´'
            },
            'swap-colors': {
                name: 'üîÑ √âchange',
                description: '√âchangez la position de deux pions',
                icon: 'üîÑ'
            },
            'wildcard': {
                name: 'üåü Joker',
                description: 'Placez un pion n\'importe o√π sur le plateau',
                icon: 'üåü'
            }
        };
        
        // Fonction pour ajouter un booster √† un joueur sp√©cifique
        function addBooster(type, player) {
            if(!boosterTypes[type]) {
                console.error('[Boosters] Type de booster inconnu:', type);
                return;
            }
            
            var booster = {
                id: Date.now() + Math.random(),
                type: type,
                player: player, // 'R' ou 'Y'
                used: false,
                ...boosterTypes[type]
            };
            
            if(player === 'R') {
                boostersR.push(booster);
            } else if(player === 'Y') {
                boostersY.push(booster);
            }
            
            renderBoosters();
            console.log('[Boosters] Nouveau booster ajout√© pour joueur', player, ':', booster.name);
        }
        
        // Fonction pour afficher les boosters
        function renderBoosters() {
            // Rendu des boosters du joueur 1 (Rouge)
            if(boostersListR) {
                if(noBoostersR) {
                    noBoostersR.style.display = boostersR.length === 0 ? 'block' : 'none';
                }
                
                var cardsR = boostersListR.querySelectorAll('.booster-card');
                cardsR.forEach(card => card.remove());
                
                boostersR.forEach(function(booster) {
                    var card = createBoosterCard(booster);
                    boostersListR.appendChild(card);
                });
            }
            
            // Rendu des boosters du joueur 2 (Jaune)
            if(boostersListY) {
                if(noBoostersY) {
                    noBoostersY.style.display = boostersY.length === 0 ? 'block' : 'none';
                }
                
                var cardsY = boostersListY.querySelectorAll('.booster-card');
                cardsY.forEach(card => card.remove());
                
                boostersY.forEach(function(booster) {
                    var card = createBoosterCard(booster);
                    boostersListY.appendChild(card);
                });
            }
        }
        
        // Fonction pour cr√©er une carte de booster
        function createBoosterCard(booster) {
            var card = document.createElement('div');
            card.className = 'booster-card' + (booster.used ? ' used' : '');
            card.innerHTML = `
                <div class="booster-header">
                    <span class="booster-icon">${booster.icon}</span>
                    <span class="booster-name">${booster.name}</span>
                </div>
                <div class="booster-description">${booster.description}</div>
            `;
            
            if(!booster.used) {
                card.addEventListener('click', function() {
                    useBooster(booster.id, booster.player);
                });
            }
            
            return card;
        }
        
        // Variables globales pour les boosters actifs
        var activeBooster = null;
        var doublePlayActive = false;
        
        // Fonction pour utiliser un booster
        function useBooster(boosterId, player) {
            // V√©rifier que c'est bien le tour du joueur
            var currentPlayer = getCurrentPlayer();
            if(currentPlayer !== player) {
                console.log('[Boosters] Ce n\'est pas le tour du joueur', player);
                return;
            }
            
            var boostersList = player === 'R' ? boostersR : boostersY;
            var booster = boostersList.find(b => b.id === boosterId);
            if(!booster || booster.used) return;
            
            console.log('[Boosters] Utilisation du booster par joueur', player, ':', booster.name);
            booster.used = true;
            
            // Ex√©cuter la logique selon le type de booster
            switch(booster.type) {
                case 'double-shot':
                    activateDoubleShot(player);
                    break;
                case 'remove-piece':
                    activateRemovePiece(player);
                    break;
                case 'block-column':
                    activateBlockColumn(player);
                    break;
                case 'swap-colors':
                    activateSwapColors(player);
                    break;
                case 'wildcard':
                    activateWildcard(player);
                    break;
                default:
                    alert('Booster non impl√©ment√©: ' + booster.name);
            }
            
            renderBoosters();
        }
        
        // ===== IMPL√âMENTATION DES BOOSTERS =====
        
        // 1. Double Coup - Jouer deux fois d'affil√©e
        function activateDoubleShot(player) {
            // Envoyer au serveur pour activer le double coup
            var form = document.createElement('form');
            form.method = 'POST';
            form.action = '/booster-action';
            
            var fields = {
                'action': 'double-shot',
                'player': player
            };
            
            for(var key in fields) {
                var input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = fields[key];
                form.appendChild(input);
            }
            
            document.body.appendChild(form);
            alert('‚ö° Double Coup activ√©!\n\nVous allez jouer deux fois d\'affil√©e.');
            console.log('[Booster] Double Coup activ√© pour', player);
            form.submit();
        }
        
        // 2. Effaceur - Retirer un pion adverse
        function activateRemovePiece(player) {
            activeBooster = {
                type: 'remove-piece',
                player: player,
                opponentColor: player === 'R' ? 'Y' : 'R'
            };
            alert('üóëÔ∏è Effaceur activ√©!\n\nCliquez sur un pion adverse pour le retirer du plateau.');
            highlightOpponentPieces(activeBooster.opponentColor);
            console.log('[Booster] Effaceur activ√© pour', player);
        }
        
        // 3. Bloqueur - Bloquer une colonne
        function activateBlockColumn(player) {
            activeBooster = {
                type: 'block-column',
                player: player
            };
            alert('üö´ Bloqueur activ√©!\n\nCliquez sur un bouton de colonne pour la bloquer pendant le prochain tour de l\'adversaire.');
            highlightColumnButtons();
            console.log('[Booster] Bloqueur activ√© pour', player);
        }
        
        // 4. √âchange - √âchanger deux pions
        var swapFirstPiece = null;
        function activateSwapColors(player) {
            activeBooster = {
                type: 'swap-colors',
                player: player
            };
            swapFirstPiece = null;
            alert('üîÑ √âchange activ√©!\n\nCliquez sur deux pions pour √©changer leurs positions.');
            highlightAllPieces();
            console.log('[Booster] √âchange activ√© pour', player);
        }
        
        // 5. Joker - Placer un pion n'importe o√π
        function activateWildcard(player) {
            activeBooster = {
                type: 'wildcard',
                player: player
            };
            alert('üåü Joker activ√©!\n\nCliquez directement sur une case vide du plateau pour y placer votre pion.');
            highlightEmptyCells();
            console.log('[Booster] Joker activ√© pour', player);
        }
        
        // ===== FONCTIONS UTILITAIRES =====
        
        function highlightOpponentPieces(color) {
            var cells = document.querySelectorAll('td[data-color="' + color + '"]');
            cells.forEach(function(cell) {
                cell.style.cursor = 'pointer';
                cell.style.boxShadow = '0 0 15px rgba(239, 68, 68, 0.8)';
                cell.classList.add('booster-target');
            });
        }
        
        function highlightColumnButtons() {
            var buttons = document.querySelectorAll('.col-button');
            buttons.forEach(function(btn) {
                btn.style.boxShadow = '0 0 15px rgba(245, 158, 11, 0.8)';
                btn.classList.add('booster-target');
            });
        }
        
        function highlightAllPieces() {
            var cells = document.querySelectorAll('td[data-color]');
            cells.forEach(function(cell) {
                if(cell.getAttribute('data-color')) {
                    cell.style.cursor = 'pointer';
                    cell.style.boxShadow = '0 0 15px rgba(59, 130, 246, 0.8)';
                    cell.classList.add('booster-target');
                }
            });
        }
        
        function highlightEmptyCells() {
            var cells = document.querySelectorAll('td:not([data-color])');
            cells.forEach(function(cell) {
                cell.style.cursor = 'pointer';
                cell.style.boxShadow = '0 0 15px rgba(34, 197, 94, 0.8)';
                cell.classList.add('booster-target');
            });
        }
        
        function removeAllHighlights() {
            var targets = document.querySelectorAll('.booster-target');
            targets.forEach(function(el) {
                el.style.cursor = '';
                el.style.boxShadow = '';
                el.classList.remove('booster-target');
            });
        }
        
        function cancelActiveBooster() {
            activeBooster = null;
            swapFirstPiece = null;
            removeAllHighlights();
        }
        
        // ===== GESTION DES CLICS SUR LE PLATEAU =====
        
        // Initialiser les √©v√©nements de clic sur le plateau en mode turbo
        if(gameMode === 'turbo') {
            // Nombre de colonnes depuis le serveur
            var boardCols = {{.Cols}};
            
            // Ajouter data-color aux cellules existantes
            var allCells = document.querySelectorAll('td');
            allCells.forEach(function(td, index) {
                var span = td.querySelector('.cell');
                if(span) {
                    if(span.classList.contains('R')) {
                        td.setAttribute('data-color', 'R');
                    } else if(span.classList.contains('Y')) {
                        td.setAttribute('data-color', 'Y');
                    }
                    
                    // Ajouter position row/col
                    var row = Math.floor(index / boardCols);
                    var col = index % boardCols;
                    td.setAttribute('data-row', row);
                    td.setAttribute('data-col', col);
                }
            });
            
            // Gestionnaire de clic sur les cellules
            document.querySelector('.board tbody').addEventListener('click', function(e) {
                if(!activeBooster) return;
                
                var td = e.target.closest('td');
                if(!td) return;
                
                var row = parseInt(td.getAttribute('data-row'));
                var col = parseInt(td.getAttribute('data-col'));
                var color = td.getAttribute('data-color');
                
                switch(activeBooster.type) {
                    case 'remove-piece':
                        if(color === activeBooster.opponentColor) {
                            handleRemovePiece(td, row, col);
                        }
                        break;
                    case 'swap-colors':
                        if(color) {
                            handleSwapPieces(td, row, col, color);
                        }
                        break;
                    case 'wildcard':
                        if(!color) {
                            handleWildcard(td, row, col);
                        }
                        break;
                }
            });
            
            // Gestionnaire de clic sur les boutons de colonnes
            document.querySelector('.board thead').addEventListener('click', function(e) {
                if(!activeBooster || activeBooster.type !== 'block-column') return;
                
                var btn = e.target.closest('.col-button');
                if(!btn) return;
                
                e.preventDefault();
                e.stopPropagation();
                
                var col = parseInt(btn.getAttribute('data-column'));
                handleBlockColumn(btn, col);
            });
        }
        
        // G√©rer l'effacement d'un pion
        function handleRemovePiece(td, row, col) {
            console.log('[Booster] Retrait du pion en', row, col);
            
            // Envoyer au serveur
            var form = document.createElement('form');
            form.method = 'POST';
            form.action = '/booster-action';
            
            var fields = {
                'action': 'remove-piece',
                'player': activeBooster.player,
                'row': row,
                'col': col
            };
            
            for(var key in fields) {
                var input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = fields[key];
                form.appendChild(input);
            }
            
            document.body.appendChild(form);
            cancelActiveBooster();
            form.submit();
        }
        
        // G√©rer l'√©change de deux pions
        function handleSwapPieces(td, row, col, color) {
            if(!swapFirstPiece) {
                // Premier pion s√©lectionn√©
                swapFirstPiece = { td: td, row: row, col: col, color: color };
                td.style.border = '3px solid #3b82f6';
                console.log('[Booster] Premier pion s√©lectionn√©:', row, col, color);
            } else {
                // Deuxi√®me pion s√©lectionn√© - √©changer
                console.log('[Booster] √âchange entre', swapFirstPiece.row, swapFirstPiece.col, 'et', row, col);
                
                swapFirstPiece.td.style.border = '';
                
                // Envoyer au serveur
                var form = document.createElement('form');
                form.method = 'POST';
                form.action = '/booster-action';
                
                var fields = {
                    'action': 'swap-colors',
                    'player': activeBooster.player,
                    'row1': swapFirstPiece.row,
                    'col1': swapFirstPiece.col,
                    'row2': row,
                    'col2': col
                };
                
                for(var key in fields) {
                    var input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = fields[key];
                    form.appendChild(input);
                }
                
                document.body.appendChild(form);
                cancelActiveBooster();
                form.submit();
            }
        }
        
        // G√©rer le placement d'un joker
        function handleWildcard(td, row, col) {
            console.log('[Booster] Placement d\'un joker en', row, col);
            
            // Envoyer au serveur
            var form = document.createElement('form');
            form.method = 'POST';
            form.action = '/booster-action';
            
            var fields = {
                'action': 'wildcard',
                'player': activeBooster.player,
                'row': row,
                'col': col
            };
            
            for(var key in fields) {
                var input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = fields[key];
                form.appendChild(input);
            }
            
            document.body.appendChild(form);
            cancelActiveBooster();
            form.submit();
        }
        
        // G√©rer le blocage d'une colonne
        var blockedColumn = null;
        function handleBlockColumn(btn, col) {
            console.log('[Booster] Blocage de la colonne', col);
            
            // Envoyer au serveur
            var form = document.createElement('form');
            form.method = 'POST';
            form.action = '/booster-action';
            
            var fields = {
                'action': 'block-column',
                'player': activeBooster.player,
                'col': col
            };
            
            for(var key in fields) {
                var input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = fields[key];
                form.appendChild(input);
            }
            
            document.body.appendChild(form);
            cancelActiveBooster();
            form.submit();
        }
        
        // Fonction pour d√©tecter le joueur actif
        function getCurrentPlayer() {
            var statusElement = document.getElementById('status');
            if(!statusElement) return null;
            
            var statusText = statusElement.textContent;
            
            // Chercher "Au tour de: [Nom] üî¥" ou "Au tour de: [Nom] üü°"
            if(statusText.indexOf('üî¥') !== -1 && statusText.indexOf('Au tour de') !== -1) {
                return 'R';
            } else if(statusText.indexOf('üü°') !== -1 && statusText.indexOf('Au tour de') !== -1) {
                return 'Y';
            }
            
            return null;
        }
        
        // Fonction pour mettre √† jour l'√©tat actif/inactif des panneaux de boosters
        function updateBoosterPanelsState() {
            if(gameMode !== 'turbo') return;
            
            var currentPlayer = getCurrentPlayer();
            
            if(!currentPlayer) {
                // Partie termin√©e, d√©sactiver les deux panneaux
                if(boostersPanelR) boostersPanelR.classList.add('inactive');
                if(boostersPanelY) boostersPanelY.classList.add('inactive');
                return;
            }
            
            // Activer le panneau du joueur actif, d√©sactiver l'autre
            if(currentPlayer === 'R') {
                if(boostersPanelR) boostersPanelR.classList.remove('inactive');
                if(boostersPanelY) boostersPanelY.classList.add('inactive');
            } else {
                if(boostersPanelR) boostersPanelR.classList.add('inactive');
                if(boostersPanelY) boostersPanelY.classList.remove('inactive');
            }
            
            console.log('[Boosters] Panneau actif pour joueur:', currentPlayer);
        }
        
        // Mettre √† jour l'√©tat des panneaux au chargement et apr√®s chaque coup
        if(gameMode === 'turbo') {
            updateBoosterPanelsState();
            
            // Observer les changements dans le status pour mettre √† jour les panneaux
            var statusElement = document.getElementById('status');
            if(statusElement && window.MutationObserver) {
                var observer = new MutationObserver(function() {
                    updateBoosterPanelsState();
                });
                observer.observe(statusElement, { childList: true, subtree: true, characterData: true });
            }
        }
        
        // POUR TESTER : Ajouter quelques boosters au d√©marrage en mode turbo
        if(gameMode === 'turbo') {
            setTimeout(function() {
                addBooster('double-shot', 'R');
                addBooster('remove-piece', 'R');
                addBooster('block-column', 'Y');
                addBooster('wildcard', 'Y');
            }, 1000);
        }
        
        // Variable pour compter le nombre de clics en jeu (persistante)
        var compte = parseInt(localStorage.getItem('compteClics')) || 0;
        console.log('[Init] Compte de clics charg√©:', compte);
        
        // Gestion des scores
        var scoreR = parseInt(localStorage.getItem('scoreR')) || 0;
        var scoreY = parseInt(localStorage.getItem('scoreY')) || 0;
        
        // Afficher les scores
        document.getElementById('scoreR').textContent = scoreR;
        document.getElementById('scoreY').textContent = scoreY;
        console.log('[Scores] Joueur 1 (R):', scoreR, '| Joueur 2 (Y):', scoreY);
        
        // D√©tecter une victoire et incr√©menter le score
        (function() {
            var statusElement = document.getElementById('status');
            if(statusElement) {
                var statusText = statusElement.textContent;
                if(statusText.indexOf('Gagnant: R') !== -1) {
                    // Joueur 1 a gagn√©
                    scoreR++;
                    localStorage.setItem('scoreR', scoreR);
                    document.getElementById('scoreR').textContent = scoreR;
                    console.log('[Victoire] Joueur 1 (R) gagne! Nouveau score:', scoreR);
                } else if(statusText.indexOf('Gagnant: Y') !== -1) {
                    // Joueur 2 a gagn√©
                    scoreY++;
                    localStorage.setItem('scoreY', scoreY);
                    document.getElementById('scoreY').textContent = scoreY;
                    console.log('[Victoire] Joueur 2 (Y) gagne! Nouveau score:', scoreY);
                }
            }
        })();
        
        // Afficher le compte dans l'interface
        var compteValueElement = document.getElementById('compteValue');
        if(compteValueElement) {
            compteValueElement.textContent = compte;
        }
        
        // Fonction pour cr√©er l'effet ghost
        function createGhostEffect(buttonElement) {
            // D√©sactiver l'effet ghost en mode classique
            if(gameMode === 'classique') {
                console.log('[Ghost] Effet d√©sactiv√© en mode classique');
                return;
            }
            
            // Utiliser l'animation ghost
            var ghostImage = '/images/anim_ghost.png';
            
            // Cr√©er l'√©l√©ment ghost
            var ghost = document.createElement('img');
            ghost.src = ghostImage;
            ghost.className = 'ghost-anim';
            ghost.style.width = '600px';
            ghost.style.height = '600px';
            
            console.log('[Ghost] Animation fant√¥me √âNORME cr√©√©e au centre de l\'√©cran');
            
            // Ajouter au body
            document.body.appendChild(ghost);
            
            // Retirer apr√®s l'animation (3 secondes)
            setTimeout(function() {
                if(ghost.parentNode) {
                    ghost.parentNode.removeChild(ghost);
                }
            }, 3000);
        }
        
        // Bouton Reset pour r√©initialiser les scores
        var resetScoresBtn = document.getElementById('resetScores');
        if(resetScoresBtn) {
            resetScoresBtn.addEventListener('click', function() {
                if(confirm('Voulez-vous vraiment r√©initialiser tous les scores √† 0 ?')) {
                    localStorage.setItem('scoreR', '0');
                    localStorage.setItem('scoreY', '0');
                    document.getElementById('scoreR').textContent = '0';
                    document.getElementById('scoreY').textContent = '0';
                    console.log('[Reset] Scores r√©initialis√©s √† 0');
                    alert('Scores r√©initialis√©s !');
                }
            });
        }
        
        // Bouton "Reset Complet" - r√©initialise la grille ET les scores en mode exponentiel
        var resetForm = document.querySelector('form[action="/reset"]');
        if(resetForm) {
            resetForm.addEventListener('submit', function(e) {
                if(gameMode === 'exponentiel') {
                    localStorage.setItem('scoreR', '0');
                    localStorage.setItem('scoreY', '0');
                    console.log('[Reset Complet] Scores r√©initialis√©s √† 0');
                }
            });
        }
        
        // Ensure column value is set when button is clicked
        (function(){
            const form = document.getElementById('playForm');
            const hiddenColumn = document.getElementById('hiddenColumn');
            if(!form || !hiddenColumn) return;
            
            // Add click handler to all column buttons
            const buttons = form.querySelectorAll('.col-button');
            buttons.forEach(function(button){
                button.addEventListener('click', function(e){
                    const columnValue = this.getAttribute('data-column');
                    hiddenColumn.value = columnValue;
                    
                    // Cr√©er l'effet ghost √† la position du bouton
                    createGhostEffect(this);
                    
                    console.log('[button click] set column to:', columnValue, '| Clics actuels:', compte);
                });
            });
            
            let isSubmitting = false;
            
            // Validate on submit
            form.addEventListener('submit', function(e){
                const columnValue = hiddenColumn.value;
                
                if(!columnValue || columnValue === ''){
                    e.preventDefault();
                    console.log('[form] prevented submission - no column value');
                    return false;
                }
                
                if(isSubmitting){
                    e.preventDefault();
                    console.log('[form] prevented duplicate submission');
                    return false;
                }
                
                // Incr√©menter et sauvegarder le compteur AVANT la soumission
                compte++;
                localStorage.setItem('compteClics', compte);
                console.log('[form submit] Colonne:', columnValue, '| Nouveau compte sauvegard√©:', compte);
                
                isSubmitting = true;
            });
        })();
    </script>
    <script src="/static/app.js" defer></script>
    
    <!-- Particles.js library -->
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script>
        // Ne pas initialiser particles.js en mode classique
        if(gameMode !== 'classique') {
            // R√©cup√©rer le compte de clics pour d√©finir le nombre de particules
            var nombreParticules = parseInt(localStorage.getItem('compteClics')) || 0;
            console.log('[Particles] Nombre de particules:', nombreParticules);
            
            // Configuration de base pour particles.js
            var particlesConfig = {
            "particles": {
                "number": {
                    "value": nombreParticules,
                    "density": {
                        "enable": true,
                        "value_area": 800
                    }
                },
                "color": {
                    "value": "#ffffff"
                },
                "shape": {
                    "type": "image",
                    "stroke": {
                        "width": 0,
                        "color": "#000000"
                    },
                    "image": {
                        "src": "/images/tete-erwann.png",
                        "width": 100,
                        "height": 100
                    }
                },
                "opacity": {
                    "value": 0.7,
                    "random": true,
                    "anim": {
                        "enable": true,
                        "speed": 1,
                        "opacity_min": 0.3,
                        "sync": false
                    }
                },
                "size": {
                    "value": 150,
                    "random": true,
                    "anim": {
                        "enable": false,
                        "speed": 40,
                        "size_min": 10,
                        "sync": false
                    }
                },
                "line_linked": {
                    "enable": false
                },
                "move": {
                    "enable": true,
                    "speed": 1.5,
                    "direction": "none",
                    "random": true,
                    "straight": false,
                    "out_mode": "out",
                    "bounce": false,
                    "attract": {
                        "enable": false,
                        "rotateX": 600,
                        "rotateY": 1200
                    }
                }
            },
            "interactivity": {
                "detect_on": "canvas",
                "events": {
                    "onhover": {
                        "enable": false
                    },
                    "onclick": {
                        "enable": false
                    },
                    "resize": true
                }
            },
            "retina_detect": true
        };

        // Choisir al√©atoirement l'image AVANT d'initialiser particles.js
        var images = ['/images/tete-erwann.png', '/images/tete-gabriel.png'];
        var randomChoice = Math.floor(Math.random() * 2);
        var chosenImageSrc = images[randomChoice];
        
        // Configurer l'image dans la config
        particlesConfig.particles.shape.image.src = chosenImageSrc;
        
        console.log('[Particles] Image choisie:', randomChoice === 0 ? 'Erwann' : 'Gabriel');
        console.log('[Particles] Nombre de particules:', particlesConfig.particles.number.value);
        
        // Initialiser particles.js avec la bonne image
        particlesJS('particles-js', particlesConfig);
        } else {
            console.log('[Particles] D√©sactiv√©es en mode classique');
        }
    </script>
</body>
</html>