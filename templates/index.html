<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Puissance 4</title>
    <link rel="stylesheet" href="/static/font.css">
    <meta name="game-version" content="{{.Version}}">
    <style>
        /* Particles.js background - cach√© en mode classique */
        #particles-js {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        /* Mode classique : fond r√©tro */
        body.mode-classique #particles-js {
            display: none;
        }
        body.mode-classique {
            background: url('/images/retro-background.gif') no-repeat center center fixed;
            background-size: cover;
        }
        
        /* Background image */
        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            font-family: system-ui, sans-serif;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            gap: 2rem;
            position: relative;
        }
        /* Game container centered */
        .game-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            max-width: 650px;
            position: relative;
            z-index: 1;
        }
        /* Scoreboard */
        .scoreboard {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            min-width: 200px;
            position: relative;
            z-index: 1;
        }
        .scoreboard h2 {
            margin: 0 0 1rem 0;
            font-size: 1.25rem;
            text-align: center;
            color: #0f172a;
        }
        .score-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            margin: 0.5rem 0;
            background: #f1f5f9;
            border-radius: 8px;
            border-left: 4px solid;
        }
        .score-item.player-r {
            border-left-color: #ef4444;
        }
        .score-item.player-y {
            border-left-color: #f59e0b;
        }
        .score-item .player-name {
            font-weight: 600;
            color: #0f172a;
        }
        .score-item .player-score {
            font-size: 1.5rem;
            font-weight: bold;
            color: #0f172a;
        }
        @media (max-width: 1024px) {
            body {
                flex-direction: column;
                gap: 1rem;
            }
        }
        h1 {
            margin: 0 0 1rem 0;
            text-align: center;
            color: #0f172a;
        }
        /* board layout */
        .board { border-collapse: collapse; margin: 1rem auto; table-layout: fixed; }
    /* increased cell size for better visibility */
    .board td { width: 60px; height: 60px; border: 3px solid #0f172a; background: #60a5fa; padding: 0; position: relative; text-align: center; vertical-align: middle; }
        .board th { padding: 0; }
    /* token circle - larger */
    .cell { width: 48px; height: 48px; border-radius: 50%; margin: 5px auto; background: #ffffff; display: block; box-shadow: inset 0 2px 4px rgba(2,6,23,0.06); border: 1px solid rgba(2,6,23,0.06); }
        .cell.R { background: #ef4444; box-shadow: none; border-color: rgba(0,0,0,0.06); }
        .cell.Y { background: #f59e0b; box-shadow: none; border-color: rgba(0,0,0,0.06); }
    /* Booster cell styling */
    .board td.booster-cell { 
        background: linear-gradient(135deg, #ec4899 0%, #a855f7 100%) !important;
        box-shadow: 0 0 20px rgba(236, 72, 153, 0.6);
        animation: boosterGlow 2s ease-in-out infinite;
        position: relative;
    }
    .board td.booster-cell::before {
        content: '‚ö°';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 30px;
        opacity: 0.8;
        pointer-events: none;
        z-index: 1;
    }
    @keyframes boosterGlow {
        0%, 100% { box-shadow: 0 0 20px rgba(236, 72, 153, 0.6); }
        50% { box-shadow: 0 0 35px rgba(236, 72, 153, 1); }
    }
    /* column buttons - bigger */
    .col-button { background: rgba(255,255,255,0.92); border: 1px solid rgba(15,23,42,0.12); cursor: pointer; width: 60px; height: 48px; display: flex; align-items: center; justify-content: center; font-size: 24px; line-height: 1; color: #0f172a; border-radius: 6px; }
    .col-button:hover { background: white; box-shadow: 0 1px 3px rgba(2,6,23,0.08); }
    .col-button:disabled { opacity: 0.35; cursor: not-allowed; background: rgba(255,255,255,0.7); }
    .col-button.blocked-column { 
        background: #ef4444 !important; 
        color: white !important; 
        border-color: #dc2626 !important;
        opacity: 1 !important;
        cursor: not-allowed !important;
        box-shadow: 0 0 15px rgba(239, 68, 68, 0.6) !important;
        animation: blockPulse 2s ease-in-out infinite;
    }
    @keyframes blockPulse {
        0%, 100% { box-shadow: 0 0 15px rgba(239, 68, 68, 0.6); }
        50% { box-shadow: 0 0 25px rgba(239, 68, 68, 0.9); }
    }
        .info { display:flex; gap:1rem; align-items:center }
    /* reset button distinctive */
    #reset { background: #1d4ed8; color: white; border: none; padding: 0.5rem 0.75rem; border-radius: 6px; cursor: pointer; }
    #reset:hover { background: #1e40af; }
    #reset:active { transform: translateY(1px); }
    #reset:focus { outline: 3px solid rgba(29,78,216,0.18); }
        @media (max-width: 480px) {
            .board td { width: 50px; height: 50px; }
            .cell { width: 40px; height: 40px; }
            .col-button { width: 50px; height: 42px; font-size: 20px; }
        }
        /* animation for dropping token - adjusted for larger size */
        .floating-token {
            position: absolute;
            width: 48px; height: 48px; border-radius: 50%;
            pointer-events: none; z-index: 20; transform: translateY(0);
            transition: transform 450ms cubic-bezier(.22,.9,.33,1);
        }
        .floating-token.R { background: #ef4444; }
        .floating-token.Y { background: #f59e0b; }
        
        /* Ghost animation effect */
        .ghost-anim {
            position: fixed;
            pointer-events: none;
            z-index: 999999;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            animation: ghostBounce 3s ease-in-out;
            opacity: 0;
            filter: drop-shadow(0 0 50px rgba(255, 255, 255, 1));
        }
        
        @keyframes ghostBounce {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.1);
            }
            15% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.5);
            }
            30% {
                transform: translate(-50%, -50%) scale(1.3);
            }
            50% {
                transform: translate(-50%, -50%) scale(1.4);
            }
            70% {
                transform: translate(-50%, -50%) scale(1.35);
            }
            85% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.3);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }
        }
        
        /* Boosters Panel */
        .boosters-panel {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(17, 24, 39, 0.95);
            border: 2px solid #3b82f6;
            border-radius: 16px;
            padding: 20px;
            min-width: 250px;
            max-width: 300px;
            box-shadow: 0 10px 40px rgba(59, 130, 246, 0.3);
            z-index: 100;
            backdrop-filter: blur(10px);
        }
        
        /* Positionner le panneau du joueur 1 √† gauche */
        .boosters-panel.boosters-player1 {
            left: 20px;
            border-color: #ef4444;
            box-shadow: 0 10px 40px rgba(239, 68, 68, 0.3);
        }
        
        .boosters-panel.boosters-player1 h2 {
            color: #f87171;
            border-bottom-color: #ef4444;
        }
        
        /* Positionner le panneau du joueur 2 √† droite */
        .boosters-panel.boosters-player2 {
            right: 20px;
            left: auto;
            border-color: #f59e0b;
            box-shadow: 0 10px 40px rgba(245, 158, 11, 0.3);
        }
        
        .boosters-panel.boosters-player2 h2 {
            color: #fbbf24;
            border-bottom-color: #f59e0b;
        }
        
        .boosters-panel h2 {
            margin: 0 0 15px 0;
            font-size: 1.3rem;
            text-align: center;
            padding-bottom: 10px;
        }
        
        .boosters-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .booster-card {
            background: linear-gradient(135deg, #1e40af 0%, #3730a3 100%);
            border: 2px solid #60a5fa;
            border-radius: 12px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            animation: boosterAppear 0.5s ease-out;
        }
        
        .booster-card:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 20px rgba(96, 165, 250, 0.5);
            border-color: #93c5fd;
        }
        
        .booster-card.used,
        .booster-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: linear-gradient(135deg, #374151 0%, #1f2937 100%);
            border-color: #4b5563;
        }
        
        .booster-card.disabled:hover {
            transform: none;
            box-shadow: none;
        }
        
        /* Griser les panneaux quand ce n'est pas le tour du joueur */
        .boosters-panel.inactive {
            opacity: 0.4;
            pointer-events: none;
        }
        
        .booster-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        
        .booster-icon {
            font-size: 1.8rem;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }
        
        .booster-name {
            font-size: 1.1rem;
            font-weight: bold;
            color: #fff;
        }
        
        .booster-description {
            font-size: 0.85rem;
            color: #cbd5e1;
            line-height: 1.4;
        }
        
        .no-boosters {
            text-align: center;
            color: #94a3b8;
            padding: 20px 10px;
        }
        
        .no-boosters p {
            margin: 0 0 8px 0;
            font-size: 1rem;
        }
        
        .no-boosters small {
            font-size: 0.8rem;
            color: #64748b;
        }
        
        @keyframes boosterAppear {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        /* Hide boosters panel in non-turbo modes */
        body:not(.mode-turbo):not(.mode-solo-turbo):not(.mode-multi-turbo) .boosters-panel {
            display: none !important;
        }
    </style>
</head>
<body class="mode-{{.Mode}}" data-rows="{{.Rows}}" data-cols="{{.Cols}}">
    <div class="game-container">
        <h1>Puissance 4</h1>
        <!-- Affichage de l'√©quipe du joueur -->
        <div id="player-team-indicator" style="text-align:center;padding:8px;margin-bottom:10px;background:#1e293b;border-radius:8px;font-weight:bold;display:none;">
            <span id="player-team-text"></span>
        </div>
        <div class="info">
        <div id="status">
            {{if .Finished}}
                {{if .Winner}}
                    {{if eq .Winner "R"}}
                        üéâ Gagnant: {{.Player1Name}} üî¥! | Prochain d√©fi: {{add .WinLength 1}} pions align√©s!
                    {{else}}
                        üéâ Gagnant: {{.Player2Name}} üü°! | Prochain d√©fi: {{add .WinLength 1}} pions align√©s!
                    {{end}}
                {{else}}
                    Match nul
                {{end}}
            {{else}}
                {{if eq .Next "R"}}
                    Au tour de: {{.Player1Name}} üî¥ | Objectif: {{.WinLength}} pions align√©s
                {{else}}
                    Au tour de: {{.Player2Name}} üü° | Objectif: {{.WinLength}} pions align√©s
                {{end}}
            {{end}}
        </div>
        <div style="display:inline-flex;align-items:center;gap:.5rem">
            <div id="compteDisplay" style="background:#16a34a;color:white;padding:0.5rem 0.75rem;border-radius:6px;font-weight:bold;">
                Clics: <span id="compteValue">0</span>
            </div>
            <button id="nextLevel" type="button">Nouvelle partie</button>
            <form method="post" action="/reset" style="display:inline">
                <input type="hidden" name="mode" value="{{.Mode}}">
                <button id="reset" type="submit" style="background:#dc2626;border:none;padding:0.5rem 0.75rem;border-radius:6px;cursor:pointer;color:white;" title="R√©initialiser la grille et la difficult√©">üîÑ Reset Complet</button>
            </form>
            <button id="effectsToggle" type="button" aria-pressed="true" title="Activer/d√©sactiver les effets">Effets</button>
            <a href="/menu" style="background:#6366f1;color:white;border:none;padding:0.5rem 0.75rem;border-radius:6px;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;" title="Retour au menu de choix des modes">üè† Menu</a>
        </div>
    </div>

    <form method="post" action="/play" id="playForm">
        <input type="hidden" name="column" id="hiddenColumn" value="">
        <input type="hidden" name="mode" id="hiddenMode" value="{{.Mode}}">
        <table class="board" aria-label="Plateau de jeu">
            <thead>
                <tr>
                    {{range $col := seq 0 (sub .Cols 1)}}
                    <th>
                        <button class="col-button {{if eq $col $.BlockedColumn}}blocked-column{{end}}" data-column="{{$col}}" type="submit" {{if $.Finished}}disabled{{end}} {{if eq $col $.BlockedColumn}}disabled{{end}}>{{if eq $col $.BlockedColumn}}üö´{{else}}‚ñº{{end}}</button>
                    </th>
                    {{end}}
                </tr>
            </thead>
            <tbody>
                {{range $r := seq 0 (sub $.Rows 1)}}
                <tr>
                    {{range $c := seq 0 (sub $.Cols 1)}}
                    <td {{if index $.BoosterCells $r $c}}class="booster-cell" data-booster="{{index $.BoosterCells $r $c}}"{{end}}>
                        {{ $cell := index $.Board $r $c }}
                        <span class="cell {{if $cell}}{{$cell}}{{end}}"></span>
                    </td>
                    {{end}}
                </tr>
                {{end}}
            </tbody>
        </table>
    </form>
    </div>
    
    <!-- Scoreboard -->
    <div class="scoreboard">
        <h2>üèÜ Scores</h2>
        <div class="score-item player-r">
            <span class="player-name">üî¥ {{.Player1Name}}</span>
            <span class="player-score" id="scoreR">0</span>
        </div>
        <div class="score-item player-y">
            <span class="player-name">üü° {{.Player2Name}}</span>
            <span class="player-score" id="scoreY">0</span>
        </div>
    </div>
    
    <!-- Boosters Panel Player 1 (visible only in turbo mode) -->
    <div class="boosters-panel boosters-player1" id="boostersPanelR" style="display: none;">
        <h2>‚ö° {{.Player1Name}} üî¥</h2>
        <div class="boosters-list" id="boostersListR">
            <!-- Les boosters du joueur 1 seront ajout√©s dynamiquement ici -->
            <div class="no-boosters" id="noBoostersR">
                <p>Aucun booster</p>
                <small>En attente...</small>
            </div>
        </div>
    </div>
    
    <!-- Boosters Panel Player 2 (visible only in turbo mode) -->
    <div class="boosters-panel boosters-player2" id="boostersPanelY" style="display: none;">
        <h2>‚ö° {{.Player2Name}} üü°</h2>
        <div class="boosters-list" id="boostersListY">
            <!-- Les boosters du joueur 2 seront ajout√©s dynamiquement ici -->
            <div class="no-boosters" id="noBoostersY">
                <p>Aucun booster</p>
                <small>En attente...</small>
            </div>
        </div>
    </div>
    
    <!-- Particles.js container for animated background -->
    <div id="particles-js"></div>
    
    <!-- Fullscreen decorative canvas for textures/animations -->
    <canvas id="bgCanvas" aria-hidden="true" style="position:fixed;inset:0;z-index:-1;pointer-events:none;" ></canvas>
    <script>
        // D√©tecter le mode de jeu et l'√©quipe du joueur
    var gameMode = document.body.className.replace('mode-', '');
    var boardRows = parseInt(document.body.dataset.rows || '0', 10);
    var boardCols = parseInt(document.body.dataset.cols || '0', 10);
        var urlParams = new URLSearchParams(window.location.search);
        var playerTeam = urlParams.get('team'); // 'R' ou 'Y'
        
        console.log('[Mode] Mode de jeu actuel:', gameMode);
        console.log('[Team] √âquipe du joueur:', playerTeam);
        
        // Afficher l'√©quipe du joueur si d√©finie
        if(playerTeam) {
            var indicator = document.getElementById('player-team-indicator');
            var teamText = document.getElementById('player-team-text');
            if(indicator && teamText) {
                if(playerTeam === 'R') {
                    teamText.textContent = 'üî¥ Tu joues Rouge';
                    indicator.style.backgroundColor = '#7f1d1d';
                    indicator.style.color = '#fecaca';
                } else if(playerTeam === 'Y') {
                    teamText.textContent = 'üü° Tu joues Jaune';
                    indicator.style.backgroundColor = '#713f12';
                    indicator.style.color = '#fef3c7';
                }
                indicator.style.display = 'block';
            }
        }
        
        // Fonction helper pour v√©rifier si on est en mode turbo
        function isTurboMode() {
            return gameMode === 'turbo' || gameMode === 'solo-turbo' || gameMode === 'multi-turbo';
        }
        
        // Auto-refresh en mode multijoueur
        (function(){
            if(gameMode !== 'multijoueur') return;
            var lastVersion = null;
            function poll(){
                fetch('/state?mode=multijoueur', {cache:'no-store'})
                .then(r=>r.json())
                .then(function(data){
                    if(lastVersion === null){
                        lastVersion = data.version;
                    } else if(data.version !== lastVersion){
                        console.log('[Multijoueur] Nouvelle version d√©tect√©e => reload');
                        location.reload();
                        return;
                    }
                    setTimeout(poll, 1000);
                })
                .catch(function(err){
                    console.warn('[Multijoueur] Erreur polling:', err);
                    setTimeout(poll, 2000);
                });
            }
            setTimeout(poll, 800);
        })();

        // ===== D√âFINITIONS GLOBALES DES BOOSTERS (doivent √™tre avant WebSocket) =====
        
        // R√©cup√©rer le code de la partie pour le localStorage
        var urlParams = new URLSearchParams(window.location.search);
        var partyCode = urlParams.get('code');
        var storageKeyR = 'boosters_R_' + partyCode;
        var storageKeyY = 'boosters_Y_' + partyCode;
        
        // Charger les boosters depuis le localStorage si disponibles
        var boostersR = []; // Boosters du joueur 1 (Rouge)
        var boostersY = []; // Boosters du joueur 2 (Jaune)
        
        try {
            var savedR = localStorage.getItem(storageKeyR);
            var savedY = localStorage.getItem(storageKeyY);
            if(savedR) boostersR = JSON.parse(savedR);
            if(savedY) boostersY = JSON.parse(savedY);
            console.log('[Storage] Boosters charg√©s - R:', boostersR.length, 'Y:', boostersY.length);
        } catch(e) {
            console.error('[Storage] Erreur chargement boosters:', e);
        }
        
        // D√©finition des types de boosters disponibles
        var boosterTypes = {
            'double-shot': {
                name: '‚ö° Double Coup',
                description: 'Jouez deux fois d\'affil√©e',
                icon: '‚ö°'
            },
            'remove-piece': {
                name: 'üóëÔ∏è Effaceur',
                description: 'Retirez un pion adverse du plateau',
                icon: 'üóëÔ∏è'
            },
            'block-column': {
                name: 'üö´ Bloqueur',
                description: 'Bloquez une colonne pendant un tour',
                icon: 'üö´'
            },
            'swap-colors': {
                name: 'üîÑ √âchange',
                description: '√âchangez la position de deux pions',
                icon: 'üîÑ'
            },
            'wildcard': {
                name: 'üåü Joker',
                description: 'Placez un pion n\'importe o√π sur le plateau',
                icon: 'üåü'
            }
        };
        
        // Fonction pour ajouter un booster √† un joueur sp√©cifique
        function addBooster(type, player) {
            if(!boosterTypes[type]) {
                console.error('[Boosters] Type de booster inconnu:', type);
                return;
            }
            
            var booster = {
                id: Date.now() + Math.random(),
                type: type,
                player: player, // 'R' ou 'Y'
                used: false,
                name: boosterTypes[type].name,
                description: boosterTypes[type].description,
                icon: boosterTypes[type].icon
            };
            
            if(player === 'R') {
                boostersR.push(booster);
                // Sauvegarder dans localStorage
                try {
                    localStorage.setItem(storageKeyR, JSON.stringify(boostersR));
                } catch(e) {
                    console.error('[Storage] Erreur sauvegarde boosters R:', e);
                }
            } else if(player === 'Y') {
                boostersY.push(booster);
                // Sauvegarder dans localStorage
                try {
                    localStorage.setItem(storageKeyY, JSON.stringify(boostersY));
                } catch(e) {
                    console.error('[Storage] Erreur sauvegarde boosters Y:', e);
                }
            }
            
            console.log('[Boosters] Nouveau booster ajout√© pour joueur', player, ':', booster.name);
            
            // Le rendu se fera plus tard dans le code
            if(typeof renderBoosters === 'function') {
                renderBoosters();
            }
        }

        // Fonction pour afficher les boosters dans les panneaux
        function renderBoosters() {
            var boostersRList = document.getElementById('boostersListR');
            var boostersYList = document.getElementById('boostersListY');
            var boostersPanelR = document.getElementById('boostersPanelR');
            var boostersPanelY = document.getElementById('boostersPanelY');
            var noBoostersR = document.getElementById('noBoostersR');
            var noBoostersY = document.getElementById('noBoostersY');
            
            if(!boostersRList || !boostersYList) return;
            
            // Afficher les panneaux si des boosters existent
            if(boostersPanelR && boostersR.length > 0) {
                boostersPanelR.style.display = 'block';
            }
            if(boostersPanelY && boostersY.length > 0) {
                boostersPanelY.style.display = 'block';
            }
            
            // G√©rer l'affichage du message "Aucun booster"
            if(noBoostersR) {
                noBoostersR.style.display = boostersR.length === 0 ? 'block' : 'none';
            }
            if(noBoostersY) {
                noBoostersY.style.display = boostersY.length === 0 ? 'block' : 'none';
            }
            
            // Supprimer les anciennes cartes (sauf le message "Aucun booster")
            var oldCardsR = boostersRList.querySelectorAll('.booster-card');
            oldCardsR.forEach(function(card) { card.remove(); });
            
            var oldCardsY = boostersYList.querySelectorAll('.booster-card');
            oldCardsY.forEach(function(card) { card.remove(); });
            
            // Afficher les boosters de R
            boostersR.forEach(function(booster) {
                var card = createBoosterCard(booster);
                boostersRList.appendChild(card);
            });
            
            // Afficher les boosters de Y
            boostersY.forEach(function(booster) {
                var card = createBoosterCard(booster);
                boostersYList.appendChild(card);
            });
            
            console.log('Boosters affich√©s - R:', boostersR.length, 'Y:', boostersY.length);
        }
        
        function createBoosterCard(booster) {
            var card = document.createElement('div');
            card.className = 'booster-card' + (booster.used ? ' used' : '');
            card.innerHTML = `
                <div class="booster-header">
                    <span class="booster-icon">${booster.icon}</span>
                    <span class="booster-name">${booster.name}</span>
                </div>
                <div class="booster-description">${booster.description}</div>
            `;
            
            if(!booster.used) {
                card.addEventListener('click', function() {
                    useBooster(booster.id, booster.player);
                });
            }
            
            return card;
        }

        // WebSocket temps r√©el pour parties avec code
        var gameWebSocket = null; // Variable globale pour le WebSocket
        
        (function(){
            // R√©cup√©rer le code de la partie depuis l'URL
            var urlParams = new URLSearchParams(window.location.search);
            var partyCode = urlParams.get('code');
            var playerTeam = urlParams.get('team'); // R√©cup√©rer l'√©quipe du joueur
            
            if(!partyCode) return; // Pas de code = pas de WebSocket
            
            // Afficher les boosters sauvegard√©s au chargement
            if(boostersR.length > 0 || boostersY.length > 0) {
                renderBoosters();
            }
            
            var supported = 'WebSocket' in window || 'MozWebSocket' in window;
            if(!supported) return;
            
            try {
                var proto = location.protocol === 'https:' ? 'wss' : 'ws';
                // Inclure l'√©quipe dans l'URL du WebSocket
                var wsUrl = proto + '://' + location.host + '/ws/' + partyCode;
                if(playerTeam) {
                    wsUrl += '?team=' + playerTeam;
                }
                gameWebSocket = new WebSocket(wsUrl);
                var lastVersion = null; // Suivre la version pour √©viter les rechargements inutiles
                
                gameWebSocket.onopen = function() {
                    console.log('[WS] Connect√© √† la partie', partyCode, '√©quipe:', playerTeam);
                };
                
                gameWebSocket.onmessage = function(evt){
                    try{
                        var data = JSON.parse(evt.data);
                        
                        // G√©rer les messages d'erreur du serveur
                        if(data.type === 'error') {
                            console.error('[WS] Erreur:', data.message);
                            alert(data.message);
                            return;
                        }
                        
                        // G√©rer la r√©ponse avec √©tat de jeu
                        if(data.type === 'state') {
                            console.log('[WS] Mise √† jour √©tat re√ßue, version:', data.state.version);
                            
                            // V√©rifier si un booster a √©t√© r√©cup√©r√©
                            if(data.booster && data.player) {
                                console.log('[Booster] Booster r√©cup√©r√©!', data.booster, 'pour joueur', data.player);
                                addBooster(data.booster, data.player);
                                
                                // Afficher une notification
                                var boosterName = boosterTypes[data.booster] ? boosterTypes[data.booster].name : data.booster;
                                var playerName = data.player === 'R' ? '{{.Player1Name}} üî¥' : '{{.Player2Name}} üü°';
                                alert('üéâ Booster r√©cup√©r√©!\n\n' + boosterName + '\n\nJoueur: ' + playerName);
                            }
                            
                            // Initialiser la version au premier message
                            if(lastVersion === null) {
                                lastVersion = data.state.version;
                                console.log('[WS] Version initiale:', lastVersion);
                                return; // Ne pas recharger au premier message
                            }
                            
                            // Recharger seulement si la version a chang√©
                            if(data.state.version !== lastVersion) {
                                console.log('[WS] Version chang√©e de', lastVersion, '√†', data.state.version, '=> reload');
                                location.reload();
                            }
                            return;
                        }
                        
                        // Format ancien (compatibilit√©)
                        console.log('[WS] Mise √† jour re√ßue, version:', data.version);
                        
                        // Initialiser la version au premier message
                        if(lastVersion === null) {
                            lastVersion = data.version;
                            console.log('[WS] Version initiale:', lastVersion);
                            return; // Ne pas recharger au premier message
                        }
                        
                        // Recharger seulement si la version a chang√©
                        if(data.version !== lastVersion) {
                            console.log('[WS] Version chang√©e de', lastVersion, '√†', data.version, '=> reload');
                            location.reload();
                        }
                    }catch(e){ 
                        console.warn('WS parse', e); 
                    }
                };
                
                gameWebSocket.onclose = function(){ 
                    console.warn('[WS] Connexion ferm√©e pour la partie', partyCode); 
                };
                
                gameWebSocket.onerror = function(err){
                    console.error('[WS] Erreur:', err);
                };
            } catch(e) {
                console.warn('[WS] Erreur init', e);
            }
        })();
        
        // Intercepter le formulaire de jeu pour envoyer via WebSocket au lieu de POST
        (function(){
            var playForm = document.getElementById('playForm');
            if(!playForm) return;
            
            playForm.addEventListener('submit', function(e) {
                e.preventDefault(); // Emp√™cher le POST classique
                
                var columnInput = playForm.querySelector('input[name="column"]');
                if(!columnInput || !columnInput.value) {
                    console.warn('[Play] Pas de colonne s√©lectionn√©e');
                    return;
                }
                
                var col = parseInt(columnInput.value);
                console.log('[Play] Envoi du coup via WebSocket, colonne:', col);
                
                // Envoyer le coup via WebSocket
                if(gameWebSocket && gameWebSocket.readyState === WebSocket.OPEN) {
                    gameWebSocket.send(JSON.stringify({
                        type: 'play',
                        col: col
                    }));
                    console.log('[Play] Coup envoy√©');
                } else {
                    console.error('[Play] WebSocket non connect√©');
                }
            });
        })();

        // Nouvelle partie: cr√©e une partie selon le mode courant et redirige
        (function(){
            var btn = document.getElementById('nextLevel');
            if(!btn) return;
            btn.addEventListener('click', async function(){
                btn.disabled = true;
                try {
                    let url = '/api/party/create?mode=' + encodeURIComponent(gameMode);
                    // En mode exponentiel, agrandir la grille pour la manche suivante
                    if (gameMode.indexOf('exponentiel') !== -1) {
                        let nextRows = Math.min(15, boardRows + 1);
                        let nextCols = Math.min(15, boardCols + 1);
                        url += '&rows=' + nextRows + '&cols=' + nextCols;
                    }
                    const res = await fetch(url, { cache: 'no-store' });
                    if(!res.ok) throw new Error('HTTP ' + res.status);
                    const data = await res.json();
                    if(data && data.code){
                        var target = '/game?code=' + encodeURIComponent(data.code);
                        if(playerTeam) target += '&team=' + encodeURIComponent(playerTeam);
                        window.location.href = target;
                    } else {
                        alert('Erreur: cr√©ation de partie impossible');
                        btn.disabled = false;
                    }
                } catch(e){
                    console.error('[NextLevel] Erreur cr√©ation partie:', e);
                    alert('Erreur serveur lors de la cr√©ation de la partie');
                    btn.disabled = false;
                }
            });
        })();

        // Gestion des boosters (mode Turbo uniquement) - Panneaux UI
        var boostersPanelR = document.getElementById('boostersPanelR');
        var boostersPanelY = document.getElementById('boostersPanelY');
        var boostersListR = document.getElementById('boostersListR');
        var boostersListY = document.getElementById('boostersListY');
        var noBoostersR = document.getElementById('noBoostersR');
        var noBoostersY = document.getElementById('noBoostersY');
        
        // Afficher les panneaux des boosters en mode turbo
        if(isTurboMode()) {
            if(boostersPanelR) boostersPanelR.style.display = 'block';
            if(boostersPanelY) boostersPanelY.style.display = 'block';
            console.log('[Boosters] Panneaux activ√©s en mode Turbo');
        }
        
        // Note: boosterTypes et addBooster() sont d√©j√† d√©finis plus haut (avant WebSocket)
        
        // Supprimer les anciennes d√©finitions dupliqu√©es - d√©but
        var boosterTypes_OLD = {
            'double-shot': {
                name: '‚ö° Double Coup',
                description: 'Jouez deux fois d\'affil√©e',
                icon: '‚ö°'
            },
            'remove-piece': {
                name: 'üóëÔ∏è Effaceur',
                description: 'Retirez un pion adverse du plateau',
                icon: 'üóëÔ∏è'
            },
            'block-column': {
                name: 'üö´ Bloqueur',
                description: 'Bloquez une colonne pendant un tour',
                icon: 'üö´'
            },
            'swap-colors': {
                name: 'üîÑ √âchange',
                description: '√âchangez la position de deux pions',
                icon: 'üîÑ'
            },
            'wildcard': {
                name: 'üåü Joker',
                description: 'Placez un pion n\'importe o√π sur le plateau',
                icon: 'üåü'
            }
        };
        // Supprimer les anciennes d√©finitions dupliqu√©es - fin (fonction addBooster d√©j√† d√©finie plus haut)
        
        // Variables globales pour les boosters actifs
        var activeBooster = null;
        var doublePlayActive = false;
        
        // Fonction pour utiliser un booster
        function useBooster(boosterId, player) {
            // V√©rifier que c'est bien le tour du joueur
            var currentPlayer = getCurrentPlayer();
            if(currentPlayer !== player) {
                console.log('[Boosters] Ce n\'est pas le tour du joueur', player);
                return;
            }
            
            var boostersList = player === 'R' ? boostersR : boostersY;
            var booster = boostersList.find(b => b.id === boosterId);
            if(!booster || booster.used) return;
            
            console.log('[Boosters] Utilisation du booster par joueur', player, ':', booster.name);
            booster.used = true;
            
            // Sauvegarder dans localStorage
            try {
                if(player === 'R') {
                    localStorage.setItem(storageKeyR, JSON.stringify(boostersR));
                } else {
                    localStorage.setItem(storageKeyY, JSON.stringify(boostersY));
                }
            } catch(e) {
                console.error('[Storage] Erreur sauvegarde apr√®s utilisation:', e);
            }
            
            // Ex√©cuter la logique selon le type de booster
            switch(booster.type) {
                case 'double-shot':
                    activateDoubleShot(player);
                    break;
                case 'remove-piece':
                    activateRemovePiece(player);
                    break;
                case 'block-column':
                    activateBlockColumn(player);
                    break;
                case 'swap-colors':
                    activateSwapColors(player);
                    break;
                case 'wildcard':
                    activateWildcard(player);
                    break;
                default:
                    alert('Booster non impl√©ment√©: ' + booster.name);
            }
            
            renderBoosters();
        }
        
        // ===== IMPL√âMENTATION DES BOOSTERS =====
        
        // 1. Double Coup - Jouer deux fois d'affil√©e
        function activateDoubleShot(player) {
            // Envoyer au serveur pour activer le double coup
            console.log('[Booster] URL compl√®te:', window.location.href);
            console.log('[Booster] Search params:', window.location.search);
            
            var urlParams = new URLSearchParams(window.location.search);
            var partyCode = urlParams.get('code');
            
            console.log('[Booster] Activation Double Coup - player:', player, 'code:', partyCode, 'type:', typeof partyCode);
            
            // En mode solo (sans code), activer localement
            if(!partyCode || partyCode === '' || partyCode === 'null') {
                doublePlayActive = true;
                alert('‚ö° Double Coup activ√©!\n\nVous allez jouer deux fois d\'affil√©e.');
                console.log('[Booster] Double Coup activ√© en mode solo pour', player);
                return;
            }
            
            var bodyData = 'action=double-shot&player=' + encodeURIComponent(player) + '&code=' + encodeURIComponent(partyCode);
            console.log('[Booster] Envoi requ√™te avec body:', bodyData);
            
            // Utiliser fetch pour envoyer la requ√™te sans recharger la page
            fetch('/booster-action', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: bodyData
            })
            .then(response => response.json())
            .then(data => {
                console.log('[Booster] R√©ponse serveur:', data);
                if(data.success) {
                    alert('‚ö° Double Coup activ√©!\n\nVous allez jouer deux fois d\'affil√©e.');
                    console.log('[Booster] Double Coup activ√© pour', player);
                } else {
                    console.error('[Booster] Erreur serveur:', data.message);
                    alert('Erreur: ' + (data.message || 'Action impossible'));
                }
            })
            .catch(error => {
                console.error('[Booster] Erreur:', error);
                alert('Erreur lors de l\'activation du booster');
            });
        }
        
        // 2. Effaceur - Retirer un pion adverse
        function activateRemovePiece(player) {
            activeBooster = {
                type: 'remove-piece',
                player: player,
                opponentColor: player === 'R' ? 'Y' : 'R'
            };
            alert('üóëÔ∏è Effaceur activ√©!\n\nCliquez sur un pion adverse pour le retirer du plateau.');
            highlightOpponentPieces(activeBooster.opponentColor);
            console.log('[Booster] Effaceur activ√© pour', player);
        }
        
        // 3. Bloqueur - Bloquer une colonne
        function activateBlockColumn(player) {
            activeBooster = {
                type: 'block-column',
                player: player
            };
            alert('üö´ Bloqueur activ√©!\n\nCliquez sur un bouton de colonne pour la bloquer pendant le prochain tour de l\'adversaire.');
            highlightColumnButtons();
            console.log('[Booster] Bloqueur activ√© pour', player);
        }
        
        // 4. √âchange - √âchanger deux pions
        var swapFirstPiece = null;
        function activateSwapColors(player) {
            activeBooster = {
                type: 'swap-colors',
                player: player
            };
            swapFirstPiece = null;
            alert('üîÑ √âchange activ√©!\n\nCliquez sur deux pions pour √©changer leurs positions.');
            highlightAllPieces();
            console.log('[Booster] √âchange activ√© pour', player);
        }
        
        // 5. Joker - Placer un pion n'importe o√π
        function activateWildcard(player) {
            activeBooster = {
                type: 'wildcard',
                player: player
            };
            alert('üåü Joker activ√©!\n\nCliquez directement sur une case vide du plateau pour y placer votre pion.');
            highlightEmptyCells();
            console.log('[Booster] Joker activ√© pour', player);
        }
        
        // ===== FONCTIONS UTILITAIRES =====
        
        // Fonction pour obtenir le code de partie
        function getPartyCode() {
            var urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('code') || '';
        }
        
        function highlightOpponentPieces(color) {
            var cells = document.querySelectorAll('td[data-color="' + color + '"]');
            cells.forEach(function(cell) {
                cell.style.cursor = 'pointer';
                cell.style.boxShadow = '0 0 15px rgba(239, 68, 68, 0.8)';
                cell.classList.add('booster-target');
            });
        }
        
        function highlightColumnButtons() {
            var buttons = document.querySelectorAll('.col-button');
            buttons.forEach(function(btn) {
                btn.style.boxShadow = '0 0 15px rgba(245, 158, 11, 0.8)';
                btn.classList.add('booster-target');
            });
        }
        
        function highlightAllPieces() {
            var cells = document.querySelectorAll('td[data-color]');
            cells.forEach(function(cell) {
                if(cell.getAttribute('data-color')) {
                    cell.style.cursor = 'pointer';
                    cell.style.boxShadow = '0 0 15px rgba(59, 130, 246, 0.8)';
                    cell.classList.add('booster-target');
                }
            });
        }
        
        function highlightEmptyCells() {
            var cells = document.querySelectorAll('td:not([data-color])');
            cells.forEach(function(cell) {
                cell.style.cursor = 'pointer';
                cell.style.boxShadow = '0 0 15px rgba(34, 197, 94, 0.8)';
                cell.classList.add('booster-target');
            });
        }
        
        function removeAllHighlights() {
            var targets = document.querySelectorAll('.booster-target');
            targets.forEach(function(el) {
                el.style.cursor = '';
                el.style.boxShadow = '';
                el.classList.remove('booster-target');
            });
        }
        
        function cancelActiveBooster() {
            activeBooster = null;
            swapFirstPiece = null;
            removeAllHighlights();
        }
        
        // ===== GESTION DES CLICS SUR LE PLATEAU =====
        
        // Initialiser les √©v√©nements de clic sur le plateau en mode turbo
        if(isTurboMode()) {
            // Nombre de colonnes (d√©j√† fourni via data attribute)
            var boardColsLocal = boardCols || 7;
            
            // Ajouter data-color aux cellules existantes
            var allCells = document.querySelectorAll('td');
            allCells.forEach(function(td, index) {
                var span = td.querySelector('.cell');
                if(span) {
                    if(span.classList.contains('R')) {
                        td.setAttribute('data-color', 'R');
                    } else if(span.classList.contains('Y')) {
                        td.setAttribute('data-color', 'Y');
                    }
                    
                    // Ajouter position row/col
                    var row = Math.floor(index / boardColsLocal);
                    var col = index % boardColsLocal;
                    td.setAttribute('data-row', row);
                    td.setAttribute('data-col', col);
                }
            });
            
            // Gestionnaire de clic sur les cellules
            document.querySelector('.board tbody').addEventListener('click', function(e) {
                if(!activeBooster) return;
                
                var td = e.target.closest('td');
                if(!td) return;
                
                var row = parseInt(td.getAttribute('data-row'));
                var col = parseInt(td.getAttribute('data-col'));
                var color = td.getAttribute('data-color');
                
                switch(activeBooster.type) {
                    case 'remove-piece':
                        if(color === activeBooster.opponentColor) {
                            handleRemovePiece(td, row, col);
                        }
                        break;
                    case 'swap-colors':
                        if(color) {
                            handleSwapPieces(td, row, col, color);
                        }
                        break;
                    case 'wildcard':
                        if(!color) {
                            handleWildcard(td, row, col);
                        }
                        break;
                }
            });
            
            // Gestionnaire de clic sur les boutons de colonnes
            document.querySelector('.board thead').addEventListener('click', function(e) {
                if(!activeBooster || activeBooster.type !== 'block-column') return;
                
                var btn = e.target.closest('.col-button');
                if(!btn) return;
                
                e.preventDefault();
                e.stopPropagation();
                
                var col = parseInt(btn.getAttribute('data-column'));
                handleBlockColumn(btn, col);
            });
        }
        
        // G√©rer l'effacement d'un pion
        function handleRemovePiece(td, row, col) {
            console.log('[Booster] Retrait du pion en', row, col);
            
            var partyCode = getPartyCode();
            var bodyData = 'action=remove-piece&player=' + encodeURIComponent(activeBooster.player) + 
                          '&row=' + row + '&col=' + col + '&code=' + encodeURIComponent(partyCode);
            
            fetch('/booster-action', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: bodyData
            })
            .then(response => response.json())
            .then(data => {
                console.log('[Booster] R√©ponse serveur:', data);
                if(data.success) {
                    console.log('[Booster] Pion retir√© avec succ√®s');
                    location.reload();
                } else {
                    alert('Erreur: ' + (data.message || 'Action impossible'));
                }
            })
            .catch(error => {
                console.error('[Booster] Erreur:', error);
                alert('Erreur lors de l\'activation du booster');
            });
            
            cancelActiveBooster();
        }
        
        // G√©rer l'√©change de deux pions
        function handleSwapPieces(td, row, col, color) {
            if(!swapFirstPiece) {
                // Premier pion s√©lectionn√©
                swapFirstPiece = { td: td, row: row, col: col, color: color };
                td.style.border = '3px solid #3b82f6';
                console.log('[Booster] Premier pion s√©lectionn√©:', row, col, color);
            } else {
                // Deuxi√®me pion s√©lectionn√© - √©changer
                console.log('[Booster] √âchange entre', swapFirstPiece.row, swapFirstPiece.col, 'et', row, col);
                
                swapFirstPiece.td.style.border = '';
                
                var partyCode = getPartyCode();
                var bodyData = 'action=swap-colors&player=' + encodeURIComponent(activeBooster.player) + 
                              '&row1=' + swapFirstPiece.row + '&col1=' + swapFirstPiece.col +
                              '&row2=' + row + '&col2=' + col + '&code=' + encodeURIComponent(partyCode);
                
                fetch('/booster-action', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: bodyData
                })
                .then(response => response.json())
                .then(data => {
                    console.log('[Booster] R√©ponse serveur:', data);
                    if(data.success) {
                        console.log('[Booster] Pions √©chang√©s avec succ√®s');
                        location.reload();
                    } else {
                        alert('Erreur: ' + (data.message || 'Action impossible'));
                    }
                })
                .catch(error => {
                    console.error('[Booster] Erreur:', error);
                    alert('Erreur lors de l\'activation du booster');
                });
                
                cancelActiveBooster();
            }
        }
        
        // G√©rer le placement d'un joker
        function handleWildcard(td, row, col) {
            console.log('[Booster] Placement d\'un joker en', row, col);
            
            var partyCode = getPartyCode();
            var bodyData = 'action=wildcard&player=' + encodeURIComponent(activeBooster.player) + 
                          '&row=' + row + '&col=' + col + '&code=' + encodeURIComponent(partyCode);
            
            fetch('/booster-action', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: bodyData
            })
            .then(response => response.json())
            .then(data => {
                console.log('[Booster] R√©ponse serveur:', data);
                if(data.success) {
                    console.log('[Booster] Joker plac√© avec succ√®s');
                    location.reload();
                } else {
                    alert('Erreur: ' + (data.message || 'Action impossible'));
                }
            })
            .catch(error => {
                console.error('[Booster] Erreur:', error);
                alert('Erreur lors de l\'activation du booster');
            });
            
            cancelActiveBooster();
        }
        
        // G√©rer le blocage d'une colonne
        var blockedColumn = null;
        function handleBlockColumn(btn, col) {
            console.log('[Booster] Blocage de la colonne', col);
            
            var partyCode = getPartyCode();
            var bodyData = 'action=block-column&player=' + encodeURIComponent(activeBooster.player) + 
                          '&col=' + col + '&code=' + encodeURIComponent(partyCode);
            
            fetch('/booster-action', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: bodyData
            })
            .then(response => response.json())
            .then(data => {
                console.log('[Booster] R√©ponse serveur:', data);
                if(data.success) {
                    console.log('[Booster] Colonne bloqu√©e avec succ√®s');
                    location.reload();
                } else {
                    alert('Erreur: ' + (data.message || 'Action impossible'));
                }
            })
            .catch(error => {
                console.error('[Booster] Erreur:', error);
                alert('Erreur lors de l\'activation du booster');
            });
            
            cancelActiveBooster();
        }
        
        // Fonction pour d√©tecter le joueur actif
        function getCurrentPlayer() {
            var statusElement = document.getElementById('status');
            if(!statusElement) return null;
            
            var statusText = statusElement.textContent;
            
            // Chercher "Au tour de: [Nom] üî¥" ou "Au tour de: [Nom] üü°"
            if(statusText.indexOf('üî¥') !== -1 && statusText.indexOf('Au tour de') !== -1) {
                return 'R';
            } else if(statusText.indexOf('üü°') !== -1 && statusText.indexOf('Au tour de') !== -1) {
                return 'Y';
            }
            
            return null;
        }
        
        // Fonction pour mettre √† jour l'√©tat actif/inactif des panneaux de boosters
        function updateBoosterPanelsState() {
            if(!isTurboMode()) return;
            
            var currentPlayer = getCurrentPlayer();
            
            if(!currentPlayer) {
                // Partie termin√©e, d√©sactiver les deux panneaux
                if(boostersPanelR) boostersPanelR.classList.add('inactive');
                if(boostersPanelY) boostersPanelY.classList.add('inactive');
                return;
            }
            
            // Activer le panneau du joueur actif, d√©sactiver l'autre
            if(currentPlayer === 'R') {
                if(boostersPanelR) boostersPanelR.classList.remove('inactive');
                if(boostersPanelY) boostersPanelY.classList.add('inactive');
            } else {
                if(boostersPanelR) boostersPanelR.classList.add('inactive');
                if(boostersPanelY) boostersPanelY.classList.remove('inactive');
            }
            
            console.log('[Boosters] Panneau actif pour joueur:', currentPlayer);
        }
        
        // Mettre √† jour l'√©tat des panneaux au chargement et apr√®s chaque coup
        if(isTurboMode()) {
            updateBoosterPanelsState();
            
            // Observer les changements dans le status pour mettre √† jour les panneaux
            var statusElement = document.getElementById('status');
            if(statusElement && window.MutationObserver) {
                var observer = new MutationObserver(function() {
                    updateBoosterPanelsState();
                });
                observer.observe(statusElement, { childList: true, subtree: true, characterData: true });
            }
        }
        
        // D√©tecter si un booster a √©t√© r√©cup√©r√© (via query params)
        if(isTurboMode()) {
            var urlParams = new URLSearchParams(window.location.search);
            var boosterType = urlParams.get('booster');
            var player = urlParams.get('player');
            
            if(boosterType && player) {
                console.log('[Booster] Booster r√©cup√©r√©!', boosterType, 'pour joueur', player);
                addBooster(boosterType, player);
                
                // Nettoyer l'URL
                window.history.replaceState({}, document.title, window.location.pathname);
                
                // Afficher une notification
                var boosterName = boosterTypes[boosterType] ? boosterTypes[boosterType].name : boosterType;
                alert('üéâ Booster r√©cup√©r√©!\n\n' + boosterName + '\n\nJoueur: ' + (player === 'R' ? '{{.Player1Name}} üî¥' : '{{.Player2Name}} üü°'));
            }
        }
        
        // Variable pour compter le nombre de clics en jeu (persistante)
        var compte = parseInt(localStorage.getItem('compteClics')) || 0;
        console.log('[Init] Compte de clics charg√©:', compte);
        
        // Gestion des scores
        var scoreR = parseInt(localStorage.getItem('scoreR')) || 0;
        var scoreY = parseInt(localStorage.getItem('scoreY')) || 0;
        
        // Afficher les scores
        document.getElementById('scoreR').textContent = scoreR;
        document.getElementById('scoreY').textContent = scoreY;
        console.log('[Scores] Joueur 1 (R):', scoreR, '| Joueur 2 (Y):', scoreY);
        
        // D√©tecter une victoire et incr√©menter le score
        (function() {
            var statusElement = document.getElementById('status');
            if(statusElement) {
                var statusText = statusElement.textContent;
                if(statusText.indexOf('Gagnant: R') !== -1) {
                    // Joueur 1 a gagn√©
                    scoreR++;
                    localStorage.setItem('scoreR', scoreR);
                    document.getElementById('scoreR').textContent = scoreR;
                    console.log('[Victoire] Joueur 1 (R) gagne! Nouveau score:', scoreR);
                } else if(statusText.indexOf('Gagnant: Y') !== -1) {
                    // Joueur 2 a gagn√©
                    scoreY++;
                    localStorage.setItem('scoreY', scoreY);
                    document.getElementById('scoreY').textContent = scoreY;
                    console.log('[Victoire] Joueur 2 (Y) gagne! Nouveau score:', scoreY);
                }
            }
        })();
        
        // Afficher le compte dans l'interface
        var compteValueElement = document.getElementById('compteValue');
        if(compteValueElement) {
            compteValueElement.textContent = compte;
        }
        
        // Fonction pour cr√©er l'effet ghost
        function createGhostEffect(buttonElement) {
            // D√©sactiver l'effet ghost en mode classique
            if(gameMode === 'classique') {
                console.log('[Ghost] Effet d√©sactiv√© en mode classique');
                return;
            }
            
            // Utiliser l'animation ghost
            var ghostImage = '/images/anim_ghost.png';
            
            // Cr√©er l'√©l√©ment ghost
            var ghost = document.createElement('img');
            ghost.src = ghostImage;
            ghost.className = 'ghost-anim';
            ghost.style.width = '600px';
            ghost.style.height = '600px';
            
            console.log('[Ghost] Animation fant√¥me √âNORME cr√©√©e au centre de l\'√©cran');
            
            // Ajouter au body
            document.body.appendChild(ghost);
            
            // Retirer apr√®s l'animation (3 secondes)
            setTimeout(function() {
                if(ghost.parentNode) {
                    ghost.parentNode.removeChild(ghost);
                }
            }, 3000);
        }
        
        // Bouton Reset pour r√©initialiser les scores
        var resetScoresBtn = document.getElementById('resetScores');
        if(resetScoresBtn) {
            resetScoresBtn.addEventListener('click', function() {
                if(confirm('Voulez-vous vraiment r√©initialiser tous les scores √† 0 ?')) {
                    localStorage.setItem('scoreR', '0');
                    localStorage.setItem('scoreY', '0');
                    document.getElementById('scoreR').textContent = '0';
                    document.getElementById('scoreY').textContent = '0';
                    console.log('[Reset] Scores r√©initialis√©s √† 0');
                    alert('Scores r√©initialis√©s !');
                }
            });
        }
        
        // Bouton "Reset Complet" - r√©initialise la grille ET les scores en mode exponentiel
        var resetForm = document.querySelector('form[action="/reset"]');
        if(resetForm) {
            resetForm.addEventListener('submit', function(e) {
                if(gameMode === 'exponentiel') {
                    localStorage.setItem('scoreR', '0');
                    localStorage.setItem('scoreY', '0');
                    console.log('[Reset Complet] Scores r√©initialis√©s √† 0');
                }
            });
        }
        
        // Ensure column value is set when button is clicked
        (function(){
            const form = document.getElementById('playForm');
            const hiddenColumn = document.getElementById('hiddenColumn');
            if(!form || !hiddenColumn) return;
            
            // Add click handler to all column buttons
            const buttons = form.querySelectorAll('.col-button');
            buttons.forEach(function(button){
                button.addEventListener('click', function(e){
                    const columnValue = this.getAttribute('data-column');
                    hiddenColumn.value = columnValue;
                    
                    // Cr√©er l'effet ghost √† la position du bouton
                    createGhostEffect(this);
                    
                    console.log('[button click] set column to:', columnValue, '| Clics actuels:', compte);
                });
            });
            
            let isSubmitting = false;
            
            // Validate on submit
            form.addEventListener('submit', function(e){
                const columnValue = hiddenColumn.value;
                
                if(!columnValue || columnValue === ''){
                    e.preventDefault();
                    console.log('[form] prevented submission - no column value');
                    return false;
                }
                
                if(isSubmitting){
                    e.preventDefault();
                    console.log('[form] prevented duplicate submission');
                    return false;
                }
                
                // Incr√©menter et sauvegarder le compteur AVANT la soumission
                compte++;
                localStorage.setItem('compteClics', compte);
                console.log('[form submit] Colonne:', columnValue, '| Nouveau compte sauvegard√©:', compte);
                
                isSubmitting = true;
            });
        })();
    </script>
    <script src="/static/app.js" defer></script>
    
    <!-- Particles.js library -->
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script>
        // Ne pas initialiser particles.js en mode classique
        if(gameMode !== 'classique') {
            // R√©cup√©rer le compte de clics pour d√©finir le nombre de particules
            var nombreParticules = parseInt(localStorage.getItem('compteClics')) || 0;
            console.log('[Particles] Nombre de particules:', nombreParticules);
            
            // Configuration de base pour particles.js
            var particlesConfig = {
            "particles": {
                "number": {
                    "value": nombreParticules,
                    "density": {
                        "enable": true,
                        "value_area": 800
                    }
                },
                "color": {
                    "value": "#ffffff"
                },
                "shape": {
                    "type": "image",
                    "stroke": {
                        "width": 0,
                        "color": "#000000"
                    },
                    "image": {
                        "src": "/images/tete-erwann.png",
                        "width": 100,
                        "height": 100
                    }
                },
                "opacity": {
                    "value": 0.7,
                    "random": true,
                    "anim": {
                        "enable": true,
                        "speed": 1,
                        "opacity_min": 0.3,
                        "sync": false
                    }
                },
                "size": {
                    "value": 150,
                    "random": true,
                    "anim": {
                        "enable": false,
                        "speed": 40,
                        "size_min": 10,
                        "sync": false
                    }
                },
                "line_linked": {
                    "enable": false
                },
                "move": {
                    "enable": true,
                    "speed": 1.5,
                    "direction": "none",
                    "random": true,
                    "straight": false,
                    "out_mode": "out",
                    "bounce": false,
                    "attract": {
                        "enable": false,
                        "rotateX": 600,
                        "rotateY": 1200
                    }
                }
            },
            "interactivity": {
                "detect_on": "canvas",
                "events": {
                    "onhover": {
                        "enable": false
                    },
                    "onclick": {
                        "enable": false
                    },
                    "resize": true
                }
            },
            "retina_detect": true
        };

        // Choisir al√©atoirement l'image AVANT d'initialiser particles.js
        var images = ['/images/tete-erwann.png', '/images/tete-gabriel.png'];
        var randomChoice = Math.floor(Math.random() * 2);
        var chosenImageSrc = images[randomChoice];
        
        // Configurer l'image dans la config
        particlesConfig.particles.shape.image.src = chosenImageSrc;
        
        console.log('[Particles] Image choisie:', randomChoice === 0 ? 'Erwann' : 'Gabriel');
        console.log('[Particles] Nombre de particules:', particlesConfig.particles.number.value);
        
        // Initialiser particles.js avec la bonne image
        particlesJS('particles-js', particlesConfig);
        } else {
            console.log('[Particles] D√©sactiv√©es en mode classique');
        }
    </script>
</body>
</html>