<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Puissance 4</title>
    <link rel="stylesheet" href="/static/font.css">
    <meta name="game-version" content="{{.Version}}">
    <style>
        /* Particles.js background - cach√© en mode classique */
        #particles-js {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        /* Mode classique : fond r√©tro */
        body.mode-classique #particles-js {
            display: none;
        }
        body.mode-classique {
            background: url('/images/retro-background.gif') no-repeat center center fixed;
            background-size: cover;
        }
        
        /* Background image */
        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            font-family: system-ui, sans-serif;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            gap: 2rem;
            position: relative;
        }
        /* Game container centered */
        .game-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            max-width: 650px;
            position: relative;
            z-index: 1;
        }
        /* Scoreboard */
        .scoreboard {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            min-width: 200px;
            position: relative;
            z-index: 1;
        }
        .scoreboard h2 {
            margin: 0 0 1rem 0;
            font-size: 1.25rem;
            text-align: center;
            color: #0f172a;
        }
        .score-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            margin: 0.5rem 0;
            background: #f1f5f9;
            border-radius: 8px;
            border-left: 4px solid;
        }
        .score-item.player-r {
            border-left-color: #ef4444;
        }
        .score-item.player-y {
            border-left-color: #f59e0b;
        }
        .score-item .player-name {
            font-weight: 600;
            color: #0f172a;
        }
        .score-item .player-score {
            font-size: 1.5rem;
            font-weight: bold;
            color: #0f172a;
        }
        @media (max-width: 1024px) {
            body {
                flex-direction: column;
                gap: 1rem;
            }
        }
        h1 {
            margin: 0 0 1rem 0;
            text-align: center;
            color: #0f172a;
        }
        /* board layout */
        .board { border-collapse: collapse; margin: 1rem auto; table-layout: fixed; }
    /* increased cell size for better visibility */
    .board td { width: 60px; height: 60px; border: 3px solid #0f172a; background: #60a5fa; padding: 0; position: relative; text-align: center; vertical-align: middle; }
        .board th { padding: 0; }
    /* token circle - larger */
    .cell { width: 48px; height: 48px; border-radius: 50%; margin: 5px auto; background: #ffffff; display: block; box-shadow: inset 0 2px 4px rgba(2,6,23,0.06); border: 1px solid rgba(2,6,23,0.06); position: relative; }
        .cell.R { background: #ef4444; box-shadow: none; border-color: rgba(0,0,0,0.06); }
        .cell.Y { background: #f59e0b; box-shadow: none; border-color: rgba(0,0,0,0.06); }
    /* Booster styles */
    .cell.has-booster { 
        box-shadow: 0 0 15px rgba(234, 179, 8, 0.6), inset 0 2px 4px rgba(2,6,23,0.06); 
        animation: boosterPulse 2s ease-in-out infinite;
    }
    @keyframes boosterPulse {
        0%, 100% { box-shadow: 0 0 15px rgba(234, 179, 8, 0.6), inset 0 2px 4px rgba(2,6,23,0.06); }
        50% { box-shadow: 0 0 25px rgba(234, 179, 8, 0.9), inset 0 2px 4px rgba(2,6,23,0.06); }
    }
    .booster-icon {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 24px;
        z-index: 10;
        text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        pointer-events: none;
    }
    /* Hide booster icon when cell has a pion */
    .cell.R .booster-icon,
    .cell.Y .booster-icon {
        display: none;
    }
    /* column buttons - bigger */
    .col-button { background: rgba(255,255,255,0.92); border: 1px solid rgba(15,23,42,0.12); cursor: pointer; width: 60px; height: 48px; display: flex; align-items: center; justify-content: center; font-size: 24px; line-height: 1; color: #0f172a; border-radius: 6px; }
    .col-button:hover { background: white; box-shadow: 0 1px 3px rgba(2,6,23,0.08); }
    .col-button:disabled { opacity: 0.35; cursor: not-allowed; background: rgba(255,255,255,0.7); }
    .col-button.blocked-column { 
        background: #ef4444 !important; 
        color: white !important; 
        border-color: #dc2626 !important;
        opacity: 1 !important;
        cursor: not-allowed !important;
        box-shadow: 0 0 15px rgba(239, 68, 68, 0.6) !important;
        animation: blockPulse 2s ease-in-out infinite;
    }
    @keyframes blockPulse {
        0%, 100% { box-shadow: 0 0 15px rgba(239, 68, 68, 0.6); }
        50% { box-shadow: 0 0 25px rgba(239, 68, 68, 0.9); }
    }
        .info { display:flex; gap:1rem; align-items:center }
    /* reset button distinctive */
    #reset { background: #1d4ed8; color: white; border: none; padding: 0.5rem 0.75rem; border-radius: 6px; cursor: pointer; }
    #reset:hover { background: #1e40af; }
    #reset:active { transform: translateY(1px); }
    #reset:focus { outline: 3px solid rgba(29,78,216,0.18); }
        @media (max-width: 480px) {
            .board td { width: 50px; height: 50px; }
            .cell { width: 40px; height: 40px; }
            .col-button { width: 50px; height: 42px; font-size: 20px; }
        }
        /* animation for dropping token - adjusted for larger size */
        .floating-token {
            position: absolute;
            width: 48px; height: 48px; border-radius: 50%;
            pointer-events: none; z-index: 20; transform: translateY(0);
            transition: transform 450ms cubic-bezier(.22,.9,.33,1);
        }
        .floating-token.R { background: #ef4444; }
        .floating-token.Y { background: #f59e0b; }
        
        /* Ghost animation effect */
        .ghost-anim {
            position: fixed;
            pointer-events: none;
            z-index: 999999;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            animation: ghostBounce 3s ease-in-out;
            opacity: 0;
            filter: drop-shadow(0 0 50px rgba(255, 255, 255, 1));
        }
        
        @keyframes ghostBounce {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.1);
            }
            15% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.5);
            }
            30% {
                transform: translate(-50%, -50%) scale(1.3);
            }
            50% {
                transform: translate(-50%, -50%) scale(1.4);
            }
            70% {
                transform: translate(-50%, -50%) scale(1.35);
            }
            85% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.3);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }
        }
        
        /* Boosters Panel */
        .boosters-panel {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(15, 23, 42, 0.98);
            border: 3px solid;
            border-radius: 12px;
            padding: 15px;
            width: 180px;
            z-index: 100;
            backdrop-filter: blur(10px);
        }
        
        /* Positionner le panneau du joueur 1 √† gauche */
        .boosters-panel.boosters-player1 {
            left: 10px;
            border-color: #ef4444;
            box-shadow: 0 0 30px rgba(239, 68, 68, 0.5);
        }
        
        .boosters-panel.boosters-player1 h2 {
            color: #ef4444;
            border-bottom: 2px solid #ef4444;
            margin: 0 0 10px 0;
            padding-bottom: 8px;
            font-size: 18px;
            text-align: center;
        }
        
        /* Positionner le panneau du joueur 2 √† droite */
        .boosters-panel.boosters-player2 {
            right: 10px;
            left: auto;
            border-color: #f59e0b;
            box-shadow: 0 0 30px rgba(245, 158, 11, 0.5);
        }
        
        .boosters-panel.boosters-player2 h2 {
            color: #f59e0b;
            border-bottom: 2px solid #f59e0b;
            margin: 0 0 10px 0;
            padding-bottom: 8px;
            font-size: 18px;
            text-align: center;
        }
        
        .boosters-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .booster-card {
            background: rgba(59, 130, 246, 0.3);
            border: 2px solid #3b82f6;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }
        
        .booster-card:hover {
            background: rgba(59, 130, 246, 0.5);
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.6);
        }
        
        .booster-card.used {
            opacity: 0.4;
            cursor: not-allowed;
            background: rgba(75, 85, 99, 0.3);
            border-color: #6b7280;
        }
        
        .booster-card.used:hover {
            transform: none;
            box-shadow: none;
        }
        
        /* Griser les panneaux quand ce n'est pas le tour du joueur */
        .boosters-panel.inactive {
            opacity: 0.4;
            pointer-events: none;
        }
        
        .booster-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .booster-icon {
            font-size: 28px;
            line-height: 1;
        }
        
        .booster-name {
            font-size: 13px;
            font-weight: 600;
            color: white;
        }
        
        .no-boosters {
            text-align: center;
            color: #9ca3af;
            padding: 20px 10px;
            font-size: 14px;
            padding: 20px 10px;
        }
        
        .no-boosters p {
            margin: 0 0 8px 0;
            font-size: 1rem;
        }
        
        .no-boosters small {
            font-size: 0.8rem;
            color: #64748b;
        }
        
        @keyframes boosterAppear {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        /* Hide boosters panel in non-turbo modes */
        body:not(.mode-turbo) .boosters-panel {
            display: none !important;
        }
    </style>
</head>
<body class="mode-{{.Mode}}">
    <div class="game-container">
        <h1>Puissance 4</h1>
        <div class="info">
        <div id="status">
            {{if .Finished}}
                {{if .Winner}}
                    {{if eq .Winner "R"}}
                        üéâ Gagnant: {{.Player1Name}} üî¥! | Prochain d√©fi: {{add .WinLength 1}} pions align√©s!
                    {{else}}
                        üéâ Gagnant: {{.Player2Name}} üü°! | Prochain d√©fi: {{add .WinLength 1}} pions align√©s!
                    {{end}}
                {{else}}
                    Match nul
                {{end}}
            {{else}}
                {{if eq .Next "R"}}
                    Au tour de: {{.Player1Name}} üî¥ | Objectif: {{.WinLength}} pions align√©s
                {{else}}
                    Au tour de: {{.Player2Name}} üü° | Objectif: {{.WinLength}} pions align√©s
                {{end}}
            {{end}}
        </div>
        <div style="display:inline-flex;align-items:center;gap:.5rem">
            <div id="compteDisplay" style="background:#16a34a;color:white;padding:0.5rem 0.75rem;border-radius:6px;font-weight:bold;">
                Clics: <span id="compteValue">0</span>
            </div>
            <button id="nextLevel" type="button" onclick="location.reload()" style="background:#1d4ed8;color:white;border:none;padding:0.5rem 0.75rem;border-radius:6px;cursor:pointer;">Nouvelle partie</button>
            <button id="reset" type="button" onclick="if(confirm('Voulez-vous vraiment r√©initialiser compl√®tement ?')) { localStorage.setItem('scoreR', '0'); localStorage.setItem('scoreY', '0'); location.reload(); }" style="background:#dc2626;border:none;padding:0.5rem 0.75rem;border-radius:6px;cursor:pointer;color:white;" title="R√©initialiser la grille et la difficult√©">üîÑ Reset Complet</button>
            <button id="effectsToggle" type="button" aria-pressed="true" title="Activer/d√©sactiver les effets">Effets</button>
            <a href="/menu" style="background:#6366f1;color:white;border:none;padding:0.5rem 0.75rem;border-radius:6px;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;" title="Retour au menu de choix des modes">üè† Menu</a>
        </div>
    </div>

    <form method="post" action="/play" id="playForm">
        <input type="hidden" name="column" id="hiddenColumn" value="">
        <table class="board" aria-label="Plateau de jeu">
            <thead>
                <tr>
                    {{range $col := seq 0 (sub .Cols 1)}}
                    <th>
                        <button class="col-button {{if eq $col $.BlockedColumn}}blocked-column{{end}}" data-column="{{$col}}" type="button" {{if $.Finished}}disabled{{end}} {{if eq $col $.BlockedColumn}}disabled{{end}}>{{if eq $col $.BlockedColumn}}üö´{{else}}‚ñº{{end}}</button>
                    </th>
                    {{end}}
                </tr>
            </thead>
            <tbody>
                {{range $r := seq 0 (sub $.Rows 1)}}
                <tr>
                    {{range $c := seq 0 (sub $.Cols 1)}}
                    <td>
                        {{ $cell := index (index $.Board $r) $c }}
                        {{ $booster := index (index $.BoosterCells $r) $c }}
                        <span class="cell {{if $cell}}{{$cell}}{{end}} {{if $booster}}has-booster{{end}}" data-booster="{{$booster}}">
                            {{if $booster}}
                            <span class="booster-icon">
                                {{if eq $booster "double-shot"}}‚ö°{{end}}
                                {{if eq $booster "remove-piece"}}üóëÔ∏è{{end}}
                                {{if eq $booster "block-column"}}üö´{{end}}
                                {{if eq $booster "swap-colors"}}üîÑ{{end}}
                                {{if eq $booster "wildcard"}}‚≠ê{{end}}
                            </span>
                            {{end}}
                        </span>
                    </td>
                    {{end}}
                </tr>
                {{end}}
            </tbody>
        </table>
    </form>
    </div>
    
    <!-- Scoreboard -->
    <div class="scoreboard">
        <h2>üèÜ Scores</h2>
        <div class="score-item player-r">
            <span class="player-name">üî¥ {{.Player1Name}}</span>
            <span class="player-score" id="scoreR">0</span>
        </div>
        <div class="score-item player-y">
            <span class="player-name">üü° {{.Player2Name}}</span>
            <span class="player-score" id="scoreY">0</span>
        </div>
    </div>
    
    <!-- Boosters Panel Player 1 (visible only in turbo mode) -->
    <div class="boosters-panel boosters-player1" id="boostersPanelR" style="{{if not .IsTurbo}}display: none;{{end}}">
        <h2>‚ö° {{.Player1Name}} üî¥</h2>
        <div class="boosters-list" id="boostersListR">
            {{if .BoostersR}}
                {{range $idx, $booster := .BoostersR}}
                <div class="booster-card {{if $booster.Used}}used{{end}}" data-booster-type="{{$booster.Type}}" data-player="R" data-index="{{$idx}}">
                    <div class="booster-header">
                        <span class="booster-icon">
                            {{if eq $booster.Type "double-shot"}}‚ö°{{end}}
                            {{if eq $booster.Type "remove-piece"}}üóëÔ∏è{{end}}
                            {{if eq $booster.Type "block-column"}}üö´{{end}}
                            {{if eq $booster.Type "swap-colors"}}üîÑ{{end}}
                            {{if eq $booster.Type "wildcard"}}‚≠ê{{end}}
                        </span>
                        <span class="booster-name">
                            {{if eq $booster.Type "double-shot"}}Double Coup{{end}}
                            {{if eq $booster.Type "remove-piece"}}Retirer Pion{{end}}
                            {{if eq $booster.Type "block-column"}}Bloquer Colonne{{end}}
                            {{if eq $booster.Type "swap-colors"}}Inverser Couleurs{{end}}
                            {{if eq $booster.Type "wildcard"}}Joker{{end}}
                        </span>
                    </div>
                </div>
                {{end}}
            {{else}}
            <div class="no-boosters" id="noBoostersR">
                <p>Aucun booster</p>
                <small>En attente...</small>
            </div>
            {{end}}
        </div>
    </div>
    
    <!-- Boosters Panel Player 2 (visible only in turbo mode) -->
    <div class="boosters-panel boosters-player2" id="boostersPanelY" style="{{if not .IsTurbo}}display: none;{{end}}">
        <h2>‚ö° {{.Player2Name}} üü°</h2>
        <div class="boosters-list" id="boostersListY">
            {{if .BoostersY}}
                {{range $idx, $booster := .BoostersY}}
                <div class="booster-card {{if $booster.Used}}used{{end}}" data-booster-type="{{$booster.Type}}" data-player="Y" data-index="{{$idx}}">
                    <div class="booster-header">
                        <span class="booster-icon">
                            {{if eq $booster.Type "double-shot"}}‚ö°{{end}}
                            {{if eq $booster.Type "remove-piece"}}üóëÔ∏è{{end}}
                            {{if eq $booster.Type "block-column"}}üö´{{end}}
                            {{if eq $booster.Type "swap-colors"}}üîÑ{{end}}
                            {{if eq $booster.Type "wildcard"}}‚≠ê{{end}}
                        </span>
                        <span class="booster-name">
                            {{if eq $booster.Type "double-shot"}}Double Coup{{end}}
                            {{if eq $booster.Type "remove-piece"}}Retirer Pion{{end}}
                            {{if eq $booster.Type "block-column"}}Bloquer Colonne{{end}}
                            {{if eq $booster.Type "swap-colors"}}Inverser Couleurs{{end}}
                            {{if eq $booster.Type "wildcard"}}Joker{{end}}
                        </span>
                    </div>
                </div>
                {{end}}
            {{else}}
            <div class="no-boosters" id="noBoostersY">
                <p>Aucun booster</p>
                <small>En attente...</small>
            </div>
            {{end}}
        </div>
    </div>
    
    <!-- Particles.js container for animated background -->
    <div id="particles-js"></div>
    
    <!-- Fullscreen decorative canvas for textures/animations -->
    <canvas id="bgCanvas" aria-hidden="true" style="position:fixed;inset:0;z-index:-1;pointer-events:none;" ></canvas>
    <script>
        // ==================== CODE KONAMI - INITIALISATION PRIORITAIRE ====================
        // Placer EN PREMIER pour √©viter les conflits avec les autres √©couteurs d'√©v√©nements
        (function() {
            var konamiSequence = ['ArrowUp', 'ArrowUp', 'ArrowDown', 'ArrowDown', 'a', 'b', 'a', 'b'];
            var konamiIndex = 0;
            var konamiActive = false; // Flag pour √©viter doubles activations
            
            console.log('üéÆ [INIT] Code Konami en cours de chargement...');
            
            function launchEasterEgg() {
                if (konamiActive) return; // √âviter les doubles activations
                konamiActive = true;
                
                console.log('üöÄ [KONAMI] Easter Egg activ√©!');
                
                // D√©tecter si on est en local ou en ligne
                var isLocal = (location.hostname === 'localhost' || location.hostname === '127.0.0.1' || location.hostname === '');
                console.log('[KONAMI] Environnement:', isLocal ? 'LOCAL' : 'EN LIGNE');
                
                // Afficher une popup diff√©rente selon l'environnement
                var confirmDialog = document.createElement('div');
                confirmDialog.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,#1a1a2e,#16213e);color:white;padding:2rem;border-radius:20px;font-size:1.2rem;z-index:999999;text-align:center;box-shadow:0 0 50px rgba(255,0,255,0.8);border:3px solid #00ff00;max-width:500px;';
                
                if(isLocal) {
                    // Mode LOCAL - Proposition de lancement
                    confirmDialog.innerHTML = '<h2 style="margin:0 0 1rem 0;color:#00ff00;font-size:2rem;">üéÆ EASTER EGG D√âCOUVERT! üéÆ</h2>' +
                        '<p style="margin:1rem 0;">Vous avez trouv√© le code secret Konami!</p>' +
                        '<p style="margin:1rem 0;font-size:1rem;"><strong>ESPERSOUL2</strong> - Un jeu d\'aventure RPG</p>' +
                        '<div style="background:rgba(0,255,0,0.1);padding:1rem;border-radius:10px;margin:1rem 0;">' +
                        '<p style="margin:0.5rem 0;font-size:0.9rem;">‚úÖ <strong>Mode Local D√©tect√©</strong></p>' +
                        '<p style="margin:0.5rem 0;font-size:0.85rem;">Le jeu peut √™tre lanc√© directement!</p>' +
                        '</div>' +
                        '<div style="display:flex;gap:1rem;justify-content:center;margin-top:1.5rem;">' +
                        '<button id="btnLaunch" style="background:#00ff00;color:#000;border:none;padding:1rem 2rem;border-radius:10px;font-size:1.1rem;font-weight:bold;cursor:pointer;">üöÄ Lancer le jeu</button>' +
                        '<button id="btnCancel" style="background:#dc2626;color:white;border:none;padding:1rem 2rem;border-radius:10px;font-size:1.1rem;font-weight:bold;cursor:pointer;">‚ùå Annuler</button>' +
                        '</div>';
                } else {
                    // Mode EN LIGNE - T√©l√©chargement direct
                    confirmDialog.innerHTML = '<h2 style="margin:0 0 1rem 0;color:#00ff00;font-size:2rem;">üéÆ EASTER EGG D√âCOUVERT! üéÆ</h2>' +
                        '<p style="margin:1rem 0;">Vous avez trouv√© le code secret Konami!</p>' +
                        '<p style="margin:1rem 0;font-size:1rem;"><strong>ESPERSOUL2</strong> - Un jeu d\'aventure RPG</p>' +
                        '<div style="background:rgba(255,165,0,0.2);padding:1rem;border-radius:10px;margin:1rem 0;">' +
                        '<p style="margin:0.5rem 0;font-size:0.9rem;">üåê <strong>Mode En Ligne</strong></p>' +
                        '<p style="margin:0.5rem 0;font-size:0.85rem;">Le jeu ne peut pas √™tre lanc√© automatiquement depuis un site web.</p>' +
                        '<p style="margin:0.5rem 0;font-size:0.85rem;">T√©l√©chargez-le pour y jouer sur votre ordinateur!</p>' +
                        '</div>' +
                        '<div style="background:rgba(255,255,255,0.1);padding:1rem;border-radius:10px;margin:1rem 0;">' +
                        '<p style="margin:0.5rem 0;font-size:0.95rem;"><strong>üìã Instructions:</strong></p>' +
                        '<ol style="text-align:left;margin:0.5rem 0;padding-left:2rem;font-size:0.9rem;">' +
                        '<li>Cliquez sur "T√©l√©charger ESPERSOUL2"</li>' +
                        '<li>Ouvrez le fichier t√©l√©charg√©</li>' +
                        '<li>Double-cliquez sur ESPERSOUL2.exe</li>' +
                        '<li>Profitez du jeu! üéÆ</li>' +
                        '</ol>' +
                        '</div>' +
                        '<div style="display:flex;gap:1rem;justify-content:center;margin-top:1.5rem;">' +
                        '<a href="/download/espersoul2" style="background:#00ff00;color:#000;border:none;padding:1rem 2rem;border-radius:10px;font-size:1.1rem;font-weight:bold;cursor:pointer;text-decoration:none;display:inline-block;">ÔøΩ T√©l√©charger ESPERSOUL2</a>' +
                        '<button id="btnCancel" style="background:#6366f1;color:white;border:none;padding:1rem 2rem;border-radius:10px;font-size:1.1rem;font-weight:bold;cursor:pointer;">‚úñÔ∏è Fermer</button>' +
                        '</div>' +
                        '<p style="margin-top:1rem;font-size:0.8rem;color:#888;">Le jeu est totalement gratuit et sans virus üõ°Ô∏è</p>';
                }
                
                document.body.appendChild(confirmDialog);
                
                // Bouton Annuler/Fermer
                var btnCancel = confirmDialog.querySelector('#btnCancel');
                btnCancel.addEventListener('click', function() {
                    confirmDialog.remove();
                    konamiActive = false;
                    console.log('üö´ [KONAMI] Ferm√© par l\'utilisateur');
                });
                
                // Bouton Lancer (uniquement en mode local)
                var btnLaunch = confirmDialog.querySelector('#btnLaunch');
                if(btnLaunch && isLocal) {
                    btnLaunch.addEventListener('click', function() {
                        console.log('‚úÖ [KONAMI] Lancement du jeu en mode local...');
                        
                        // Tentative de lancement
                        fetch('/api/launch-easteregg', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'}
                        })
                        .then(function(response) { return response.json(); })
                        .then(function(data) {
                            console.log('‚úÖ [KONAMI] R√©ponse serveur:', data);
                            
                            // V√©rifier si c'est un t√©l√©chargement ou un lancement
                            if(data.method === 'download') {
                                // Proposer le t√©l√©chargement au lieu du lancement
                                confirmDialog.innerHTML = '<h2 style="margin:0 0 1rem 0;color:#ff9500;font-size:2rem;">üíæ T√âL√âCHARGEMENT</h2>' +
                                    '<p style="margin:1rem 0;">Le lancement automatique n\'est pas disponible.</p>' +
                                    '<p style="margin:0.5rem 0;font-size:0.9rem;">T√©l√©chargez le jeu pour y jouer!</p>' +
                                    '<div style="display:flex;gap:1rem;justify-content:center;margin-top:1.5rem;">' +
                                    '<a href="/download/espersoul2" style="background:#00ff00;color:#000;border:none;padding:1rem 2rem;border-radius:10px;font-size:1.1rem;font-weight:bold;cursor:pointer;text-decoration:none;display:inline-block;">üíæ T√©l√©charger ESPERSOUL2</a>' +
                                    '<button id="btnClose" style="background:#6366f1;color:white;border:none;padding:1rem 2rem;border-radius:10px;font-size:1.1rem;font-weight:bold;cursor:pointer;">‚úñÔ∏è Fermer</button>' +
                                    '</div>';
                                
                                var btnClose = confirmDialog.querySelector('#btnClose');
                                btnClose.addEventListener('click', function() {
                                    confirmDialog.remove();
                                    konamiActive = false;
                                });
                            } else {
                                // Lancement r√©ussi
                                confirmDialog.innerHTML = '<h2 style="margin:0 0 1rem 0;color:#00ff00;font-size:2rem;">‚úÖ JEU LANC√â!</h2>' +
                                    '<p style="margin:1rem 0;">ESPERSOUL2 devrait s\'ouvrir dans une nouvelle fen√™tre.</p>' +
                                    '<p style="margin:0.5rem 0;font-size:0.9rem;">Regardez votre barre des t√¢ches!</p>' +
                                    '<button id="btnOk" style="background:#00ff00;color:#000;border:none;padding:1rem 2rem;border-radius:10px;font-size:1rem;cursor:pointer;margin-top:1rem;">OK</button>';
                                
                                var btnOk = confirmDialog.querySelector('#btnOk');
                                btnOk.addEventListener('click', function() {
                                    confirmDialog.remove();
                                    konamiActive = false;
                                });
                                
                                setTimeout(function() {
                                    if(confirmDialog.parentNode) {
                                        confirmDialog.remove();
                                        konamiActive = false;
                                    }
                                }, 5000);
                            }
                        })
                        .catch(function(error) {
                            console.error('‚ùå [KONAMI] Erreur serveur:', error);
                            confirmDialog.innerHTML = '<h2 style="margin:0 0 1rem 0;color:#ff9500;font-size:2rem;">‚ö†Ô∏è ERREUR</h2>' +
                                '<p style="margin:1rem 0;">Impossible de contacter le serveur.</p>' +
                                '<p style="margin:0.5rem 0;font-size:0.85rem;">T√©l√©chargez le jeu √† la place:</p>' +
                                '<div style="display:flex;gap:1rem;justify-content:center;margin-top:1.5rem;">' +
                                '<a href="/download/espersoul2" style="background:#00ff00;color:#000;border:none;padding:1rem 2rem;border-radius:10px;font-size:1.1rem;font-weight:bold;cursor:pointer;text-decoration:none;display:inline-block;">üíæ T√©l√©charger</a>' +
                                '<button id="btnClose" style="background:#6366f1;color:white;border:none;padding:1rem 2rem;border-radius:10px;font-size:1.1rem;font-weight:bold;cursor:pointer;">‚úñÔ∏è Fermer</button>' +
                                '</div>';
                            
                            var btnClose = confirmDialog.querySelector('#btnClose');
                            btnClose.addEventListener('click', function() {
                                confirmDialog.remove();
                                konamiActive = false;
                            });
                        });
                    });
                }
            }
            
            // √âcouteur prioritaire en phase de capture
            document.addEventListener('keydown', function(e) {
                var expectedKey = konamiSequence[konamiIndex];
                var pressedKey = e.key;
                
                // Log uniquement si on est dans une s√©quence active
                if(konamiIndex > 0 || expectedKey === pressedKey || (expectedKey === 'ArrowUp' && pressedKey === 'ArrowUp')) {
                    console.log('üéπ [KONAMI]', konamiIndex + '/' + konamiSequence.length, '| Touche:', pressedKey, '| Attendu:', expectedKey);
                }
                
                // Comparaison
                var isMatch = false;
                if(expectedKey === 'a' || expectedKey === 'b') {
                    isMatch = pressedKey.toLowerCase() === expectedKey;
                } else {
                    isMatch = pressedKey === expectedKey;
                }
                
                if(isMatch) {
                    konamiIndex++;
                    console.log('‚úÖ [KONAMI] Correct! [' + konamiIndex + '/' + konamiSequence.length + ']');
                    
                    if(konamiIndex === konamiSequence.length) {
                        console.log('üéä [KONAMI] S√âQUENCE COMPL√àTE! ACTIVATION!');
                        konamiActive = true;
                        launchEasterEgg();
                        konamiIndex = 0;
                    }
                } else {
                    if(konamiIndex > 0) {
                        console.log('‚ùå [KONAMI] Reset (attendu: ' + expectedKey + ')');
                    }
                    konamiIndex = 0;
                }
            }, true); // true = capture phase (priorit√© maximale)
            
            console.log('üéÆ [INIT] Code Konami activ√©! S√©quence: ‚Üë ‚Üë ‚Üì ‚Üì A B A B');
        })();
        
        // D√©tecter le mode de jeu et le code de la partie
        var gameMode = document.body.className.replace('mode-', '');
        var partyCode = new URLSearchParams(window.location.search).get('code');
        console.log('[Mode] Mode de jeu actuel:', gameMode, '| Code partie:', partyCode);
        
        // WebSocket pour tous les modes (solo et multi)
        var gameWS = null;
        (function(){
            if(!partyCode) {
                console.warn('[WS] Pas de code de partie, mode d√©connect√©');
                return;
            }
            
            var proto = location.protocol === 'https:' ? 'wss' : 'ws';
            var wsUrl = proto + '://' + location.host + '/ws/' + partyCode;
            console.log('[WS] Connexion √†:', wsUrl);
            
            try {
                gameWS = new WebSocket(wsUrl);
                
                gameWS.onopen = function() {
                    console.log('[WS] ‚úÖ Connect√© au serveur de jeu');
                };
                
                gameWS.onmessage = function(evt) {
                    try {
                        var data = JSON.parse(evt.data);
                        console.log('[WS] Message re√ßu:', data);
                        
                        if(data.type === 'error') {
                            alert(data.message);
                            return;
                        }
                        
                        // Mise √† jour de l'√©tat du jeu
                        if(data.type === 'state' || data.state || data.Board || data.Next || data.Finished !== undefined) {
                            console.log('[WS] √âtat du jeu mis √† jour, rechargement...');
                            location.reload();
                        }
                    } catch(e) {
                        console.warn('[WS] Erreur parsing:', e);
                    }
                };
                
                gameWS.onerror = function(err) {
                    console.error('[WS] ‚ùå Erreur:', err);
                };
                
                gameWS.onclose = function() {
                    console.warn('[WS] üîå Connexion ferm√©e');
                };
            } catch(e) {
                console.error('[WS] Erreur init:', e);
            }
        })();
        
        // Gestion des boosters (mode Turbo uniquement)
        var boostersR = []; // Boosters du joueur 1 (Rouge)
        var boostersY = []; // Boosters du joueur 2 (Jaune)
        var boostersPanelR = document.getElementById('boostersPanelR');
        var boostersPanelY = document.getElementById('boostersPanelY');
        var boostersListR = document.getElementById('boostersListR');
        var boostersListY = document.getElementById('boostersListY');
        var noBoostersR = document.getElementById('noBoostersR');
        var noBoostersY = document.getElementById('noBoostersY');
        
        // Afficher les panneaux des boosters en mode turbo
        if(gameMode.indexOf('turbo') !== -1) {
            if(boostersPanelR) boostersPanelR.style.display = 'block';
            if(boostersPanelY) boostersPanelY.style.display = 'block';
            console.log('[Boosters] Panneaux activ√©s en mode Turbo');
            
            // Attacher les √©v√©nements de clic sur les cartes de boosters existantes
            document.querySelectorAll('.booster-card:not(.used)').forEach(function(card) {
                card.addEventListener('click', function() {
                    var boosterType = card.getAttribute('data-booster-type');
                    var player = card.getAttribute('data-player');
                    var index = parseInt(card.getAttribute('data-index'));
                    
                    console.log('[Boosters] Clic sur booster:', boosterType, 'joueur:', player);
                    useBoosterFromCard(boosterType, player, index, card);
                });
                card.style.cursor = 'pointer';
            });
        }
        
        // D√©finition des types de boosters disponibles
        var boosterTypes = {
            'double-shot': {
                name: '‚ö° Double Coup',
                description: 'Jouez deux fois d\'affil√©e',
                icon: '‚ö°'
            },
            'remove-piece': {
                name: 'üóëÔ∏è Effaceur',
                description: 'Retirez un pion adverse du plateau',
                icon: 'üóëÔ∏è'
            },
            'block-column': {
                name: 'üö´ Bloqueur',
                description: 'Bloquez une colonne pendant un tour',
                icon: 'üö´'
            },
            'swap-colors': {
                name: 'üîÑ √âchange',
                description: '√âchangez la position de deux pions',
                icon: 'üîÑ'
            },
            'wildcard': {
                name: 'üåü Joker',
                description: 'Placez un pion n\'importe o√π sur le plateau',
                icon: 'üåü'
            }
        };
        
        // Fonction pour ajouter un booster √† un joueur sp√©cifique
        function addBooster(type, player) {
            if(!boosterTypes[type]) {
                console.error('[Boosters] Type de booster inconnu:', type);
                return;
            }
            
            var booster = {
                id: Date.now() + Math.random(),
                type: type,
                player: player, // 'R' ou 'Y'
                used: false,
                ...boosterTypes[type]
            };
            
            if(player === 'R') {
                boostersR.push(booster);
            } else if(player === 'Y') {
                boostersY.push(booster);
            }
            
            renderBoosters();
            console.log('[Boosters] Nouveau booster ajout√© pour joueur', player, ':', booster.name);
        }
        
        // Fonction pour afficher les boosters
        function renderBoosters() {
            // Rendu des boosters du joueur 1 (Rouge)
            if(boostersListR) {
                if(noBoostersR) {
                    noBoostersR.style.display = boostersR.length === 0 ? 'block' : 'none';
                }
                
                var cardsR = boostersListR.querySelectorAll('.booster-card');
                cardsR.forEach(card => card.remove());
                
                boostersR.forEach(function(booster) {
                    var card = createBoosterCard(booster);
                    boostersListR.appendChild(card);
                });
            }
            
            // Rendu des boosters du joueur 2 (Jaune)
            if(boostersListY) {
                if(noBoostersY) {
                    noBoostersY.style.display = boostersY.length === 0 ? 'block' : 'none';
                }
                
                var cardsY = boostersListY.querySelectorAll('.booster-card');
                cardsY.forEach(card => card.remove());
                
                boostersY.forEach(function(booster) {
                    var card = createBoosterCard(booster);
                    boostersListY.appendChild(card);
                });
            }
        }
        
        // Fonction pour cr√©er une carte de booster
        function createBoosterCard(booster) {
            var card = document.createElement('div');
            card.className = 'booster-card' + (booster.used ? ' used' : '');
            card.innerHTML = `
                <div class="booster-header">
                    <span class="booster-icon">${booster.icon}</span>
                    <span class="booster-name">${booster.name}</span>
                </div>
                <div class="booster-description">${booster.description}</div>
            `;
            
            if(!booster.used) {
                card.addEventListener('click', function() {
                    useBooster(booster.id, booster.player);
                });
            }
            
            return card;
        }
        
        // Variables globales pour les boosters actifs
        var activeBooster = null;
        var doublePlayActive = false;
        
        // Fonction pour utiliser un booster
        
        // Fonction pour utiliser un booster depuis une carte du template (g√©n√©r√©e par le serveur)
        function useBoosterFromCard(boosterType, player, index, cardElement) {
            // V√©rifier que c'est bien le tour du joueur
            var currentPlayer = getCurrentPlayer();
            if(currentPlayer !== player) {
                alert('‚ö†Ô∏è Ce n\'est pas votre tour!');
                console.log('[Boosters] Ce n\'est pas le tour du joueur', player);
                return;
            }
            
            console.log('[Boosters] Utilisation du booster par joueur', player, ':', boosterType);
            
            // Marquer visuellement comme utilis√©
            if(cardElement) {
                cardElement.classList.add('used');
                cardElement.style.cursor = 'not-allowed';
            }
            
            // Ex√©cuter la logique selon le type de booster
            switch(boosterType) {
                case 'double-shot':
                    activateDoubleShot(player, index);
                    break;
                case 'remove-piece':
                    activateRemovePiece(player, index);
                    break;
                case 'block-column':
                    activateBlockColumn(player, index);
                    break;
                case 'swap-colors':
                    activateSwapColors(player, index);
                    break;
                case 'wildcard':
                    activateWildcard(player, index);
                    break;
                default:
                    alert('Booster non impl√©ment√©: ' + boosterType);
            }
        }
        
        function useBooster(boosterId, player) {
            // V√©rifier que c'est bien le tour du joueur
            var currentPlayer = getCurrentPlayer();
            if(currentPlayer !== player) {
                console.log('[Boosters] Ce n\'est pas le tour du joueur', player);
                return;
            }
            
            var boostersList = player === 'R' ? boostersR : boostersY;
            var booster = boostersList.find(b => b.id === boosterId);
            if(!booster || booster.used) return;
            
            console.log('[Boosters] Utilisation du booster par joueur', player, ':', booster.name);
            booster.used = true;
            
            // Ex√©cuter la logique selon le type de booster
            switch(booster.type) {
                case 'double-shot':
                    activateDoubleShot(player);
                    break;
                case 'remove-piece':
                    activateRemovePiece(player);
                    break;
                case 'block-column':
                    activateBlockColumn(player);
                    break;
                case 'swap-colors':
                    activateSwapColors(player);
                    break;
                case 'wildcard':
                    activateWildcard(player);
                    break;
                default:
                    alert('Booster non impl√©ment√©: ' + booster.name);
            }
            
            renderBoosters();
        }
        
        // ===== IMPL√âMENTATION DES BOOSTERS =====
        
        // 1. Double Coup - Jouer deux fois d'affil√©e
        function activateDoubleShot(player, index) {
            // Envoyer au serveur via WebSocket pour activer le double coup
            if(gameWS && gameWS.readyState === WebSocket.OPEN) {
                gameWS.send(JSON.stringify({
                    type: 'booster',
                    action: 'double-shot',
                    player: player,
                    index: index
                }));
                alert('‚ö° Double Coup activ√©!\n\nVous allez jouer deux fois d\'affil√©e.');
                console.log('[Booster] Double Coup activ√© pour', player);
            } else {
                alert('‚ùå Erreur: Connexion perdue');
            }
        }
        
        // 2. Effaceur - Retirer un pion adverse
        function activateRemovePiece(player) {
            activeBooster = {
                type: 'remove-piece',
                player: player,
                opponentColor: player === 'R' ? 'Y' : 'R'
            };
            alert('üóëÔ∏è Effaceur activ√©!\n\nCliquez sur un pion adverse pour le retirer du plateau.');
            highlightOpponentPieces(activeBooster.opponentColor);
            console.log('[Booster] Effaceur activ√© pour', player);
        }
        
        // 3. Bloqueur - Bloquer une colonne
        function activateBlockColumn(player) {
            activeBooster = {
                type: 'block-column',
                player: player
            };
            alert('üö´ Bloqueur activ√©!\n\nCliquez sur un bouton de colonne pour la bloquer pendant le prochain tour de l\'adversaire.');
            highlightColumnButtons();
            console.log('[Booster] Bloqueur activ√© pour', player);
        }
        
        // 4. √âchange - √âchanger deux pions
        var swapFirstPiece = null;
        function activateSwapColors(player) {
            activeBooster = {
                type: 'swap-colors',
                player: player
            };
            swapFirstPiece = null;
            alert('üîÑ √âchange activ√©!\n\nCliquez sur deux pions pour √©changer leurs positions.');
            highlightAllPieces();
            console.log('[Booster] √âchange activ√© pour', player);
        }
        
        // 5. Joker - Placer un pion n'importe o√π
        function activateWildcard(player) {
            activeBooster = {
                type: 'wildcard',
                player: player
            };
            alert('üåü Joker activ√©!\n\nCliquez directement sur une case vide du plateau pour y placer votre pion.');
            highlightEmptyCells();
            console.log('[Booster] Joker activ√© pour', player);
        }
        
        // ===== FONCTIONS UTILITAIRES =====
        
        function highlightOpponentPieces(color) {
            var cells = document.querySelectorAll('td[data-color="' + color + '"]');
            cells.forEach(function(cell) {
                cell.style.cursor = 'pointer';
                cell.style.boxShadow = '0 0 15px rgba(239, 68, 68, 0.8)';
                cell.classList.add('booster-target');
            });
        }
        
        function highlightColumnButtons() {
            var buttons = document.querySelectorAll('.col-button');
            buttons.forEach(function(btn) {
                btn.style.boxShadow = '0 0 15px rgba(245, 158, 11, 0.8)';
                btn.classList.add('booster-target');
            });
        }
        
        function highlightAllPieces() {
            var cells = document.querySelectorAll('td[data-color]');
            cells.forEach(function(cell) {
                if(cell.getAttribute('data-color')) {
                    cell.style.cursor = 'pointer';
                    cell.style.boxShadow = '0 0 15px rgba(59, 130, 246, 0.8)';
                    cell.classList.add('booster-target');
                }
            });
        }
        
        function highlightEmptyCells() {
            var cells = document.querySelectorAll('td:not([data-color])');
            cells.forEach(function(cell) {
                cell.style.cursor = 'pointer';
                cell.style.boxShadow = '0 0 15px rgba(34, 197, 94, 0.8)';
                cell.classList.add('booster-target');
            });
        }
        
        function removeAllHighlights() {
            var targets = document.querySelectorAll('.booster-target');
            targets.forEach(function(el) {
                el.style.cursor = '';
                el.style.boxShadow = '';
                el.classList.remove('booster-target');
            });
        }
        
        function cancelActiveBooster() {
            activeBooster = null;
            swapFirstPiece = null;
            removeAllHighlights();
        }
        
        // ===== GESTION DES CLICS SUR LE PLATEAU =====
        
        // Initialiser les √©v√©nements de clic sur le plateau en mode turbo
        if(gameMode.indexOf('turbo') !== -1) {
            // Nombre de colonnes depuis le serveur
            var boardCols = parseInt(document.querySelector('.board thead tr').children.length) || 7;
            
            // Ajouter data-color aux cellules existantes
            var allCells = document.querySelectorAll('td');
            allCells.forEach(function(td, index) {
                var span = td.querySelector('.cell');
                if(span) {
                    if(span.classList.contains('R')) {
                        td.setAttribute('data-color', 'R');
                    } else if(span.classList.contains('Y')) {
                        td.setAttribute('data-color', 'Y');
                    }
                    
                    // Ajouter position row/col
                    var row = Math.floor(index / boardCols);
                    var col = index % boardCols;
                    td.setAttribute('data-row', row);
                    td.setAttribute('data-col', col);
                }
            });
            
            // Gestionnaire de clic sur les cellules
            document.querySelector('.board tbody').addEventListener('click', function(e) {
                if(!activeBooster) return;
                
                var td = e.target.closest('td');
                if(!td) return;
                
                var row = parseInt(td.getAttribute('data-row'));
                var col = parseInt(td.getAttribute('data-col'));
                var color = td.getAttribute('data-color');
                
                switch(activeBooster.type) {
                    case 'remove-piece':
                        if(color === activeBooster.opponentColor) {
                            handleRemovePiece(td, row, col);
                        }
                        break;
                    case 'swap-colors':
                        if(color) {
                            handleSwapPieces(td, row, col, color);
                        }
                        break;
                    case 'wildcard':
                        if(!color) {
                            handleWildcard(td, row, col);
                        }
                        break;
                }
            });
            
            // Gestionnaire de clic sur les boutons de colonnes
            document.querySelector('.board thead').addEventListener('click', function(e) {
                if(!activeBooster || activeBooster.type !== 'block-column') return;
                
                var btn = e.target.closest('.col-button');
                if(!btn) return;
                
                e.preventDefault();
                e.stopPropagation();
                
                var col = parseInt(btn.getAttribute('data-column'));
                handleBlockColumn(btn, col);
            });
        }
        
        // G√©rer l'effacement d'un pion
        function handleRemovePiece(td, row, col) {
            console.log('[Booster] Retrait du pion en', row, col);
            
            // Envoyer au serveur
            var form = document.createElement('form');
            form.method = 'POST';
            form.action = '/booster-action';
            
            var fields = {
                'action': 'remove-piece',
                'player': activeBooster.player,
                'row': row,
                'col': col
            };
            
            for(var key in fields) {
                var input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = fields[key];
                form.appendChild(input);
            }
            
            document.body.appendChild(form);
            cancelActiveBooster();
            form.submit();
        }
        
        // G√©rer l'√©change de deux pions
        function handleSwapPieces(td, row, col, color) {
            if(!swapFirstPiece) {
                // Premier pion s√©lectionn√©
                swapFirstPiece = { td: td, row: row, col: col, color: color };
                td.style.border = '3px solid #3b82f6';
                console.log('[Booster] Premier pion s√©lectionn√©:', row, col, color);
            } else {
                // Deuxi√®me pion s√©lectionn√© - √©changer
                console.log('[Booster] √âchange entre', swapFirstPiece.row, swapFirstPiece.col, 'et', row, col);
                
                swapFirstPiece.td.style.border = '';
                
                // Envoyer au serveur
                var form = document.createElement('form');
                form.method = 'POST';
                form.action = '/booster-action';
                
                var fields = {
                    'action': 'swap-colors',
                    'player': activeBooster.player,
                    'row1': swapFirstPiece.row,
                    'col1': swapFirstPiece.col,
                    'row2': row,
                    'col2': col
                };
                
                for(var key in fields) {
                    var input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = fields[key];
                    form.appendChild(input);
                }
                
                document.body.appendChild(form);
                cancelActiveBooster();
                form.submit();
            }
        }
        
        // G√©rer le placement d'un joker
        function handleWildcard(td, row, col) {
            console.log('[Booster] Placement d\'un joker en', row, col);
            
            // Envoyer au serveur
            var form = document.createElement('form');
            form.method = 'POST';
            form.action = '/booster-action';
            
            var fields = {
                'action': 'wildcard',
                'player': activeBooster.player,
                'row': row,
                'col': col
            };
            
            for(var key in fields) {
                var input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = fields[key];
                form.appendChild(input);
            }
            
            document.body.appendChild(form);
            cancelActiveBooster();
            form.submit();
        }
        
        // G√©rer le blocage d'une colonne
        var blockedColumn = null;
        function handleBlockColumn(btn, col) {
            console.log('[Booster] Blocage de la colonne', col);
            
            // Envoyer au serveur
            var form = document.createElement('form');
            form.method = 'POST';
            form.action = '/booster-action';
            
            var fields = {
                'action': 'block-column',
                'player': activeBooster.player,
                'col': col
            };
            
            for(var key in fields) {
                var input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = fields[key];
                form.appendChild(input);
            }
            
            document.body.appendChild(form);
            cancelActiveBooster();
            form.submit();
        }
        
        // Fonction pour d√©tecter le joueur actif
        function getCurrentPlayer() {
            var statusElement = document.getElementById('status');
            if(!statusElement) return null;
            
            var statusText = statusElement.textContent;
            
            // Chercher "Au tour de: [Nom] üî¥" ou "Au tour de: [Nom] üü°"
            if(statusText.indexOf('üî¥') !== -1 && statusText.indexOf('Au tour de') !== -1) {
                return 'R';
            } else if(statusText.indexOf('üü°') !== -1 && statusText.indexOf('Au tour de') !== -1) {
                return 'Y';
            }
            
            return null;
        }
        
        // Fonction pour mettre √† jour l'√©tat actif/inactif des panneaux de boosters
        function updateBoosterPanelsState() {
            if(gameMode.indexOf('turbo') === -1) return;
            
            var currentPlayer = getCurrentPlayer();
            
            if(!currentPlayer) {
                // Partie termin√©e, d√©sactiver les deux panneaux
                if(boostersPanelR) boostersPanelR.classList.add('inactive');
                if(boostersPanelY) boostersPanelY.classList.add('inactive');
                return;
            }
            
            // Activer le panneau du joueur actif, d√©sactiver l'autre
            if(currentPlayer === 'R') {
                if(boostersPanelR) boostersPanelR.classList.remove('inactive');
                if(boostersPanelY) boostersPanelY.classList.add('inactive');
            } else {
                if(boostersPanelR) boostersPanelR.classList.add('inactive');
                if(boostersPanelY) boostersPanelY.classList.remove('inactive');
            }
            
            console.log('[Boosters] Panneau actif pour joueur:', currentPlayer);
        }
        
        // Mettre √† jour l'√©tat des panneaux au chargement et apr√®s chaque coup
        if(gameMode.indexOf('turbo') !== -1) {
            updateBoosterPanelsState();
            
            // Observer les changements dans le status pour mettre √† jour les panneaux
            var statusElement = document.getElementById('status');
            if(statusElement && window.MutationObserver) {
                var observer = new MutationObserver(function() {
                    updateBoosterPanelsState();
                });
                observer.observe(statusElement, { childList: true, subtree: true, characterData: true });
            }
        }
        
        // POUR TESTER : Ajouter quelques boosters au d√©marrage en mode turbo
        if(gameMode.indexOf('turbo') !== -1) {
            setTimeout(function() {
                addBooster('double-shot', 'R');
                addBooster('remove-piece', 'R');
                addBooster('block-column', 'Y');
                addBooster('wildcard', 'Y');
            }, 1000);
        }
        
        // Variable pour compter le nombre de clics en jeu (persistante)
        var compte = parseInt(localStorage.getItem('compteClics')) || 0;
        console.log('[Init] Compte de clics charg√©:', compte);
        
        // Gestion des scores
        var scoreR = parseInt(localStorage.getItem('scoreR')) || 0;
        var scoreY = parseInt(localStorage.getItem('scoreY')) || 0;
        
        // Afficher les scores
        document.getElementById('scoreR').textContent = scoreR;
        document.getElementById('scoreY').textContent = scoreY;
        console.log('[Scores] Joueur 1 (R):', scoreR, '| Joueur 2 (Y):', scoreY);
        
        // D√©tecter une victoire et incr√©menter le score
        (function() {
            var statusElement = document.getElementById('status');
            if(statusElement) {
                var statusText = statusElement.textContent;
                if(statusText.indexOf('Gagnant: R') !== -1) {
                    // Joueur 1 a gagn√©
                    scoreR++;
                    localStorage.setItem('scoreR', scoreR);
                    document.getElementById('scoreR').textContent = scoreR;
                    console.log('[Victoire] Joueur 1 (R) gagne! Nouveau score:', scoreR);
                } else if(statusText.indexOf('Gagnant: Y') !== -1) {
                    // Joueur 2 a gagn√©
                    scoreY++;
                    localStorage.setItem('scoreY', scoreY);
                    document.getElementById('scoreY').textContent = scoreY;
                    console.log('[Victoire] Joueur 2 (Y) gagne! Nouveau score:', scoreY);
                }
            }
        })();
        
        // Afficher le compte dans l'interface
        var compteValueElement = document.getElementById('compteValue');
        if(compteValueElement) {
            compteValueElement.textContent = compte;
        }
        
        // Fonction pour cr√©er l'effet ghost
        function createGhostEffect(buttonElement) {
            // Effet fant√¥me d√©sactiv√©
            console.log('[Ghost] Effet fant√¥me d√©sactiv√©');
            return;
        }
        
        // Bouton Reset pour r√©initialiser les scores
        var resetScoresBtn = document.getElementById('resetScores');
        if(resetScoresBtn) {
            resetScoresBtn.addEventListener('click', function() {
                if(confirm('Voulez-vous vraiment r√©initialiser tous les scores √† 0 ?')) {
                    localStorage.setItem('scoreR', '0');
                    localStorage.setItem('scoreY', '0');
                    document.getElementById('scoreR').textContent = '0';
                    document.getElementById('scoreY').textContent = '0';
                    console.log('[Reset] Scores r√©initialis√©s √† 0');
                    alert('Scores r√©initialis√©s !');
                }
            });
        }
        
        // Bouton "Reset Complet" - r√©initialise la grille ET les scores en mode exponentiel
        var resetForm = document.querySelector('form[action="/reset"]');
        if(resetForm) {
            resetForm.addEventListener('submit', function(e) {
                if(gameMode.indexOf('exponentiel') !== -1) {
                    localStorage.setItem('scoreR', '0');
                    localStorage.setItem('scoreY', '0');
                    console.log('[Reset Complet] Scores r√©initialis√©s √† 0');
                }
            });
        }
        
        // Gestion des clics sur les colonnes - ENVOYER VIA WEBSOCKET
        (function(){
            const form = document.getElementById('playForm');
            const hiddenColumn = document.getElementById('hiddenColumn');
            if(!form || !hiddenColumn) return;
            
            // Add click handler to all column buttons
            const buttons = form.querySelectorAll('.col-button');
            buttons.forEach(function(button){
                button.addEventListener('click', function(e){
                    const columnValue = parseInt(this.getAttribute('data-column'));
                    hiddenColumn.value = columnValue;
                    
                    // Cr√©er l'effet ghost √† la position du bouton
                    createGhostEffect(this);
                    
                    console.log('[button click] Colonne:', columnValue);
                    
                    // Envoyer le coup via WebSocket
                    if(gameWS && gameWS.readyState === WebSocket.OPEN) {
                        console.log('[WS] Envoi du coup:', columnValue);
                        gameWS.send(JSON.stringify({
                            type: 'play',
                            col: columnValue
                        }));
                        
                        // Incr√©menter le compteur de clics
                        compte++;
                        localStorage.setItem('compteClics', compte);
                        console.log('[Clics] Nouveau compte:', compte);
                    } else {
                        console.error('[WS] ‚ùå WebSocket non connect√©!');
                        alert('Connexion au serveur perdue. Rechargez la page.');
                    }
                });
            });
            
            let isSubmitting = false;
            
            // EMP√äCHER TOUTE SOUMISSION DE FORMULAIRE (le jeu utilise maintenant WebSocket/AJAX)
            form.addEventListener('submit', function(e){
                e.preventDefault(); // TOUJOURS emp√™cher la soumission
                console.log('[form] Soumission bloqu√©e - le jeu utilise WebSocket/AJAX');
                return false;
            });
        })();   
    </script>
    <script src="/static/app.js" defer></script>
    
    <!-- Particles.js library -->
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script>
        // Ne pas initialiser particles.js en mode classique
        if(gameMode.indexOf('classique') === -1) {
            // R√©cup√©rer le compte de clics pour d√©finir le nombre de particules
            var nombreParticules = parseInt(localStorage.getItem('compteClics')) || 0;
            console.log('[Particles] Nombre de particules:', nombreParticules);
            
            // Configuration de base pour particles.js
            var particlesConfig = {
            "particles": {
                "number": {
                    "value": nombreParticules,
                    "density": {
                        "enable": true,
                        "value_area": 800
                    }
                },
                "color": {
                    "value": "#ffffff"
                },
                "shape": {
                    "type": "image",
                    "stroke": {
                        "width": 0,
                        "color": "#000000"
                    },
                    "image": {
                        "src": "/images/tete-erwann.png",
                        "width": 100,
                        "height": 100
                    }
                },
                "opacity": {
                    "value": 0.7,
                    "random": true,
                    "anim": {
                        "enable": true,
                        "speed": 1,
                        "opacity_min": 0.3,
                        "sync": false
                    }
                },
                "size": {
                    "value": 150,
                    "random": true,
                    "anim": {
                        "enable": false,
                        "speed": 40,
                        "size_min": 10,
                        "sync": false
                    }
                },
                "line_linked": {
                    "enable": false
                },
                "move": {
                    "enable": true,
                    "speed": 1.5,
                    "direction": "none",
                    "random": true,
                    "straight": false,
                    "out_mode": "out",
                    "bounce": false,
                    "attract": {
                        "enable": false,
                        "rotateX": 600,
                        "rotateY": 1200
                    }
                }
            },
            "interactivity": {
                "detect_on": "canvas",
                "events": {
                    "onhover": {
                        "enable": false
                    },
                    "onclick": {
                        "enable": false
                    },
                    "resize": true
                }
            },
            "retina_detect": true
        };

        // Choisir al√©atoirement l'image AVANT d'initialiser particles.js
        var images = ['/images/tete-erwann.png', '/images/tete-gabriel.png'];
        var randomChoice = Math.floor(Math.random() * 2);
        var chosenImageSrc = images[randomChoice];
        
        // Configurer l'image dans la config
        particlesConfig.particles.shape.image.src = chosenImageSrc;
        
        console.log('[Particles] Image choisie:', randomChoice === 0 ? 'Erwann' : 'Gabriel');
        console.log('[Particles] Nombre de particules:', particlesConfig.particles.number.value);
        
        // Initialiser particles.js avec la bonne image
        particlesJS('particles-js', particlesConfig);
        } else {
            console.log('[Particles] D√©sactiv√©es en mode classique');
        }
    </script>
</body>
</html>